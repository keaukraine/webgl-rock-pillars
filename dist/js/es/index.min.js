class t{enterFullScreen(){document.fullscreenElement||document.documentElement.requestFullscreen({navigationUI:"hide"})}exitFullScreen(){document.exitFullscreen&&document.exitFullscreen()}addFullScreenListener(t){document.addEventListener("fullscreenchange",t,!1)}isFullScreen(){return!!document.fullscreenElement}}class e{static async load(t){return(await fetch(t)).arrayBuffer()}}class i{static load(t,e,i=e.LINEAR,r=e.LINEAR,n=!1){return new Promise(((s,o)=>{const a=e.createTexture();if(null===a)return void o("Error creating WebGL texture");const h=new Image;h.src=t,h.onload=()=>{e.bindTexture(e.TEXTURE_2D,a),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,h),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,i),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,r),!0===n?(e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE)):(e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.REPEAT),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.REPEAT)),e.bindTexture(e.TEXTURE_2D,null),h&&h.src&&console.log(`Loaded texture ${t} [${h.width}x${h.height}]`),s(a)},h.onerror=()=>o("Cannot load image")}))}static async loadCubemap(t,e,i="png"){const r=e.createTexture();if(null===r)throw new Error("Error creating WebGL texture");e.bindTexture(e.TEXTURE_CUBE_MAP,r),e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_MIN_FILTER,e.NEAREST);const n=[{type:e.TEXTURE_CUBE_MAP_POSITIVE_X,suffix:`-posx.${i}`},{type:e.TEXTURE_CUBE_MAP_NEGATIVE_X,suffix:`-negx.${i}`},{type:e.TEXTURE_CUBE_MAP_POSITIVE_Y,suffix:`-posy.${i}`},{type:e.TEXTURE_CUBE_MAP_NEGATIVE_Y,suffix:`-negy.${i}`},{type:e.TEXTURE_CUBE_MAP_POSITIVE_Z,suffix:`-posz.${i}`},{type:e.TEXTURE_CUBE_MAP_NEGATIVE_Z,suffix:`-negz.${i}`}].map((i=>new Promise(((n,s)=>{const o=new Image;o.src=t+i.suffix,o.onload=()=>{e.bindTexture(e.TEXTURE_CUBE_MAP,r),e.texImage2D(i.type,0,e.RGB,e.RGB,e.UNSIGNED_BYTE,o),o&&o.src&&console.log(`Loaded texture ${t}${i.suffix} [${o.width}x${o.height}]`),n()},o.onerror=()=>s("Cannot load image")}))));return await Promise.all(n),e.bindTexture(e.TEXTURE_2D,null),r}}class r{constructor(){this.numIndices=0}loadBuffer(t,e,i,r){var n=new Uint8Array(r,0,r.byteLength);t.bindBuffer(i,e),t.bufferData(i,n,t.STATIC_DRAW)}async load(t,i){const[r,n]=await Promise.all([e.load(`${t}-indices.bin`),e.load(`${t}-strides.bin`)]);console.log(`Loaded ${t}-indices.bin (${r.byteLength} bytes)`),console.log(`Loaded ${t}-strides.bin (${n.byteLength} bytes)`),this.bufferIndices=i.createBuffer(),this.loadBuffer(i,this.bufferIndices,i.ELEMENT_ARRAY_BUFFER,r),this.numIndices=r.byteLength/2/3,this.bufferStrides=i.createBuffer(),this.loadBuffer(i,this.bufferStrides,i.ARRAY_BUFFER,n)}bindBuffers(t){t.bindBuffer(t.ARRAY_BUFFER,this.bufferStrides),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.bufferIndices)}getNumIndices(){return this.numIndices}}class n{constructor(t){this.gl=t,this.vertexShaderCode="",this.fragmentShaderCode="",this.fillCode(),this.initShader()}getShader(t,e){const i=this.gl.createShader(t);if(i){if(this.gl.shaderSource(i,e),this.gl.compileShader(i),this.gl.getShaderParameter(i,this.gl.COMPILE_STATUS))return i;console.warn(this.gl.getShaderInfoLog(i))}else console.warn("Error creating shader.")}getUniform(t){if(void 0===this.program)throw new Error("No program for shader.");const e=this.gl.getUniformLocation(this.program,t);if(null!==e)return e;throw new Error(`Cannot get uniform "${t}".`)}getAttrib(t){if(void 0===this.program)throw new Error("No program for shader.");return this.gl.getAttribLocation(this.program,t)}initShader(){const t=this.getShader(this.gl.FRAGMENT_SHADER,this.fragmentShaderCode),e=this.getShader(this.gl.VERTEX_SHADER,this.vertexShaderCode),i=this.gl.createProgram();void 0!==t&&void 0!==e&&null!==i&&(this.gl.attachShader(i,e),this.gl.attachShader(i,t),this.gl.linkProgram(i),this.gl.getProgramParameter(i,this.gl.LINK_STATUS)?console.log(this.constructor.name+": Initialised shader"):console.warn(this.constructor.name+": Could not initialise shader"),this.gl.useProgram(i),this.program=i,this.fillUniformsAttributes())}use(){this.program&&this.gl.useProgram(this.program)}deleteProgram(){this.program&&this.gl.deleteProgram(this.program)}}var s="undefined"!=typeof Float32Array?Float32Array:Array;function o(){var t=new s(16);return s!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0),t[0]=1,t[5]=1,t[10]=1,t[15]=1,t}function a(t,e,i){var r=e[0],n=e[1],s=e[2],o=e[3],a=e[4],h=e[5],l=e[6],d=e[7],c=e[8],u=e[9],f=e[10],m=e[11],g=e[12],_=e[13],p=e[14],x=e[15],v=i[0],b=i[1],E=i[2],A=i[3];return t[0]=v*r+b*a+E*c+A*g,t[1]=v*n+b*h+E*u+A*_,t[2]=v*s+b*l+E*f+A*p,t[3]=v*o+b*d+E*m+A*x,v=i[4],b=i[5],E=i[6],A=i[7],t[4]=v*r+b*a+E*c+A*g,t[5]=v*n+b*h+E*u+A*_,t[6]=v*s+b*l+E*f+A*p,t[7]=v*o+b*d+E*m+A*x,v=i[8],b=i[9],E=i[10],A=i[11],t[8]=v*r+b*a+E*c+A*g,t[9]=v*n+b*h+E*u+A*_,t[10]=v*s+b*l+E*f+A*p,t[11]=v*o+b*d+E*m+A*x,v=i[12],b=i[13],E=i[14],A=i[15],t[12]=v*r+b*a+E*c+A*g,t[13]=v*n+b*h+E*u+A*_,t[14]=v*s+b*l+E*f+A*p,t[15]=v*o+b*d+E*m+A*x,t}function h(){var t=new s(3);return s!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function l(t,e,i){var r=new s(3);return r[0]=t,r[1]=e,r[2]=i,r}Math.hypot||(Math.hypot=function(){for(var t=0,e=arguments.length;e--;)t+=arguments[e]*arguments[e];return Math.sqrt(t)});function d(){var t=new s(4);return s!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t[3]=1,t}h(),function(){var t,e=(t=new s(4),s!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[3]=0),t)}();var c;h(),l(1,0,0),l(0,1,0),d(),d(),c=new s(9),s!=Float32Array&&(c[1]=0,c[2]=0,c[3]=0,c[5]=0,c[6]=0,c[7]=0),c[0]=1,c[4]=1,c[8]=1,function(){var t=function(){var t=new s(2);return s!=Float32Array&&(t[0]=0,t[1]=0),t}()}();class u{constructor(t){this.gl=t,this.m_textureHandle=null,this.m_depthTextureHandle=null,this.m_framebufferHandle=null,this.m_depthbufferHandle=null}createGLData(t,e){if(this.m_width=t,this.m_height=e,null!==this.m_textureHandle&&this.m_width>0&&this.m_height>0){this.m_framebufferHandle=this.gl.createFramebuffer(),null!==this.m_textureHandle&&(this.gl.bindTexture(this.gl.TEXTURE_2D,this.m_textureHandle),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.m_framebufferHandle),this.gl.framebufferTexture2D(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,this.gl.TEXTURE_2D,this.m_textureHandle,0),this.checkGlError("FB")),null===this.m_depthTextureHandle?(this.m_depthbufferHandle=this.gl.createRenderbuffer(),this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,this.m_depthbufferHandle),this.checkGlError("FB - glBindRenderbuffer"),this.gl.renderbufferStorage(this.gl.RENDERBUFFER,this.gl.DEPTH_COMPONENT16,this.m_width,this.m_height),this.checkGlError("FB - glRenderbufferStorage"),this.gl.framebufferRenderbuffer(this.gl.FRAMEBUFFER,this.gl.DEPTH_ATTACHMENT,this.gl.RENDERBUFFER,this.m_depthbufferHandle),this.checkGlError("FB - glFramebufferRenderbuffer")):(this.gl.bindTexture(this.gl.TEXTURE_2D,this.m_depthTextureHandle),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.m_framebufferHandle),this.gl.framebufferTexture2D(this.gl.FRAMEBUFFER,this.gl.DEPTH_ATTACHMENT,this.gl.TEXTURE_2D,this.m_depthTextureHandle,0),this.checkGlError("FB depth"));const t=this.gl.checkFramebufferStatus(this.gl.FRAMEBUFFER);t!=this.gl.FRAMEBUFFER_COMPLETE&&console.error(`Error creating framebufer: ${t}`),this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,null),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null)}}checkGlError(t){let e;for(;(e=this.gl.getError())!==this.gl.NO_ERROR;)console.error(`${t}: glError ${e}`)}get width(){return this.m_width}set width(t){this.m_width=t}get height(){return this.m_height}set height(t){this.m_height=t}get textureHandle(){return this.m_textureHandle}set textureHandle(t){this.m_textureHandle=t}get depthbufferHandle(){return this.m_depthbufferHandle}set depthbufferHandle(t){this.m_depthbufferHandle=t}get framebufferHandle(){return this.m_framebufferHandle}set framebufferHandle(t){this.m_framebufferHandle=t}get depthTextureHandle(){return this.m_depthTextureHandle}set depthTextureHandle(t){this.m_depthTextureHandle=t}}class f{static createNpotTexture(t,e,i,r=!1){const n=t.createTexture();t.bindTexture(t.TEXTURE_2D,n),t.texParameterf(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameterf(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE);let s=null,o=null;return r?(s=t.RGBA,o=t.RGBA):(s=t.RGB,o=t.RGB),t.texImage2D(t.TEXTURE_2D,0,o,e,i,0,s,t.UNSIGNED_BYTE,null),n}static createDepthTexture(t,e,i){const r=t.createTexture();t.bindTexture(t.TEXTURE_2D,r),t.texParameterf(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameterf(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE);const n=t.getParameter(t.VERSION)||"",s=t.DEPTH_COMPONENT,o=n.includes("WebGL 2")?t.DEPTH_COMPONENT16:t.DEPTH_COMPONENT,a=t.UNSIGNED_SHORT;return t.texImage2D(t.TEXTURE_2D,0,o,e,i,0,s,a,null),r}}class m{getStart(){return this.start}getEnd(){return this.end}getFramesCount(){return this.frames}getCurrentCoeff(){return this.currentCoeff}constructor(t){this.frames=t,this.start=0,this.end=0,this.currentCoeff=0}clamp(t,e,i){return Math.max(Math.min(t,i),e)}animate(t){const e=this.clamp(t,0,1);this.start=Math.trunc(e*(this.frames-1)),this.start==this.frames-1&&(this.start=this.frames-2),this.end=this.start+1,this.currentCoeff=e*(this.frames-1)-this.start}}class g extends n{fillCode(){this.vertexShaderCode="uniform mat4 view_proj_matrix;\nattribute vec4 rm_Vertex;\nattribute vec2 rm_TexCoord0;\nvarying vec2 vTextureCoord;\n\nvoid main() {\n  gl_Position = view_proj_matrix * rm_Vertex;\n  vTextureCoord = rm_TexCoord0;\n}",this.fragmentShaderCode="precision mediump float;\nvarying vec2 vTextureCoord;\nuniform sampler2D sTexture;\n\nvoid main() {\n  gl_FragColor = texture2D(sTexture, vTextureCoord);\n}"}fillUniformsAttributes(){this.view_proj_matrix=this.getUniform("view_proj_matrix"),this.rm_Vertex=this.getAttrib("rm_Vertex"),this.rm_TexCoord0=this.getAttrib("rm_TexCoord0"),this.sTexture=this.getUniform("sTexture")}drawModel(t,e,i,r,n,s,o,a,h,l,d,c){if(void 0===this.rm_Vertex||void 0===this.rm_TexCoord0||void 0===this.view_proj_matrix)return;const u=t.gl;if(e.bindBuffers(u),u.enableVertexAttribArray(this.rm_Vertex),u.enableVertexAttribArray(this.rm_TexCoord0),c)for(const[t,e]of c)u.vertexAttribPointer(t,...e);else u.vertexAttribPointer(this.rm_Vertex,3,u.FLOAT,!1,20,0),u.vertexAttribPointer(this.rm_TexCoord0,2,u.FLOAT,!1,20,12);t.calculateMVPMatrix(i,r,n,s,o,a,h,l,d),u.uniformMatrix4fv(this.view_proj_matrix,!1,t.getMVPMatrix()),u.drawElements(u.TRIANGLES,3*e.getNumIndices(),u.UNSIGNED_SHORT,0),t.checkGlError("DiffuseShader glDrawElements")}}
/*! *****************************************************************************
Copyright (c) Microsoft Corporation. All rights reserved.
Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at http://www.apache.org/licenses/LICENSE-2.0

THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
MERCHANTABLITY OR NON-INFRINGEMENT.

See the Apache Version 2.0 License for specific language governing permissions
and limitations under the License.
***************************************************************************** */function _(t,e,i,r){return new(i||(i=Promise))((function(n,s){function o(t){try{h(r.next(t))}catch(t){s(t)}}function a(t){try{h(r.throw(t))}catch(t){s(t)}}function h(t){t.done?n(t.value):new i((function(e){e(t.value)})).then(o,a)}h((r=r.apply(t,e||[])).next())}))}var p="undefined"!=typeof Float32Array?Float32Array:Array;function x(){var t=new p(16);return p!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0),t[0]=1,t[5]=1,t[10]=1,t[15]=1,t}function v(t){var e=new p(16);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}function b(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function E(t,e){var i=e[0],r=e[1],n=e[2],s=e[3],o=e[4],a=e[5],h=e[6],l=e[7],d=e[8],c=e[9],u=e[10],f=e[11],m=e[12],g=e[13],_=e[14],p=e[15],x=i*a-r*o,v=i*h-n*o,b=i*l-s*o,E=r*h-n*a,A=r*l-s*a,T=n*l-s*h,R=d*g-c*m,C=d*_-u*m,w=d*p-f*m,M=c*_-u*g,y=c*p-f*g,F=u*p-f*_,S=x*F-v*y+b*M+E*w-A*C+T*R;return S?(S=1/S,t[0]=(a*F-h*y+l*M)*S,t[1]=(n*y-r*F-s*M)*S,t[2]=(g*T-_*A+p*E)*S,t[3]=(u*A-c*T-f*E)*S,t[4]=(h*w-o*F-l*C)*S,t[5]=(i*F-n*w+s*C)*S,t[6]=(_*b-m*T-p*v)*S,t[7]=(d*T-u*b+f*v)*S,t[8]=(o*y-a*w+l*R)*S,t[9]=(r*w-i*y-s*R)*S,t[10]=(m*A-g*b+p*x)*S,t[11]=(c*b-d*A-f*x)*S,t[12]=(a*C-o*M-h*R)*S,t[13]=(i*M-r*C+n*R)*S,t[14]=(g*v-m*E-_*x)*S,t[15]=(d*E-c*v+u*x)*S,t):null}function A(t,e,i){var r=e[0],n=e[1],s=e[2],o=e[3],a=e[4],h=e[5],l=e[6],d=e[7],c=e[8],u=e[9],f=e[10],m=e[11],g=e[12],_=e[13],p=e[14],x=e[15],v=i[0],b=i[1],E=i[2],A=i[3];return t[0]=v*r+b*a+E*c+A*g,t[1]=v*n+b*h+E*u+A*_,t[2]=v*s+b*l+E*f+A*p,t[3]=v*o+b*d+E*m+A*x,v=i[4],b=i[5],E=i[6],A=i[7],t[4]=v*r+b*a+E*c+A*g,t[5]=v*n+b*h+E*u+A*_,t[6]=v*s+b*l+E*f+A*p,t[7]=v*o+b*d+E*m+A*x,v=i[8],b=i[9],E=i[10],A=i[11],t[8]=v*r+b*a+E*c+A*g,t[9]=v*n+b*h+E*u+A*_,t[10]=v*s+b*l+E*f+A*p,t[11]=v*o+b*d+E*m+A*x,v=i[12],b=i[13],E=i[14],A=i[15],t[12]=v*r+b*a+E*c+A*g,t[13]=v*n+b*h+E*u+A*_,t[14]=v*s+b*l+E*f+A*p,t[15]=v*o+b*d+E*m+A*x,t}function T(t,e,i){var r,n,s,o,a,h,l,d,c,u,f,m,g=i[0],_=i[1],p=i[2];return e===t?(t[12]=e[0]*g+e[4]*_+e[8]*p+e[12],t[13]=e[1]*g+e[5]*_+e[9]*p+e[13],t[14]=e[2]*g+e[6]*_+e[10]*p+e[14],t[15]=e[3]*g+e[7]*_+e[11]*p+e[15]):(r=e[0],n=e[1],s=e[2],o=e[3],a=e[4],h=e[5],l=e[6],d=e[7],c=e[8],u=e[9],f=e[10],m=e[11],t[0]=r,t[1]=n,t[2]=s,t[3]=o,t[4]=a,t[5]=h,t[6]=l,t[7]=d,t[8]=c,t[9]=u,t[10]=f,t[11]=m,t[12]=r*g+a*_+c*p+e[12],t[13]=n*g+h*_+u*p+e[13],t[14]=s*g+l*_+f*p+e[14],t[15]=o*g+d*_+m*p+e[15]),t}function R(t,e,i){var r=i[0],n=i[1],s=i[2];return t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t[3]=e[3]*r,t[4]=e[4]*n,t[5]=e[5]*n,t[6]=e[6]*n,t[7]=e[7]*n,t[8]=e[8]*s,t[9]=e[9]*s,t[10]=e[10]*s,t[11]=e[11]*s,t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}function C(t,e,i){var r=Math.sin(i),n=Math.cos(i),s=e[4],o=e[5],a=e[6],h=e[7],l=e[8],d=e[9],c=e[10],u=e[11];return e!==t&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[4]=s*n+l*r,t[5]=o*n+d*r,t[6]=a*n+c*r,t[7]=h*n+u*r,t[8]=l*n-s*r,t[9]=d*n-o*r,t[10]=c*n-a*r,t[11]=u*n-h*r,t}function w(t,e,i){var r=Math.sin(i),n=Math.cos(i),s=e[0],o=e[1],a=e[2],h=e[3],l=e[8],d=e[9],c=e[10],u=e[11];return e!==t&&(t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=s*n-l*r,t[1]=o*n-d*r,t[2]=a*n-c*r,t[3]=h*n-u*r,t[8]=s*r+l*n,t[9]=o*r+d*n,t[10]=a*r+c*n,t[11]=h*r+u*n,t}function M(t,e,i){var r=Math.sin(i),n=Math.cos(i),s=e[0],o=e[1],a=e[2],h=e[3],l=e[4],d=e[5],c=e[6],u=e[7];return e!==t&&(t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=s*n+l*r,t[1]=o*n+d*r,t[2]=a*n+c*r,t[3]=h*n+u*r,t[4]=l*n-s*r,t[5]=d*n-o*r,t[6]=c*n-a*r,t[7]=u*n-h*r,t}function y(t,e){return t[0]=e[12],t[1]=e[13],t[2]=e[14],t}Math.hypot||(Math.hypot=function(){for(var t=0,e=arguments.length;e--;)t+=arguments[e]*arguments[e];return Math.sqrt(t)});var F=function(t,e,i,r,n,s,o){var a=1/(e-i),h=1/(r-n),l=1/(s-o);return t[0]=-2*a,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*h,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=2*l,t[11]=0,t[12]=(e+i)*a,t[13]=(n+r)*h,t[14]=(o+s)*l,t[15]=1,t};function S(){var t=new p(3);return p!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function O(t,e,i){return t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i,t}function P(t,e){var i=e[0],r=e[1],n=e[2],s=i*i+r*r+n*n;return s>0&&(s=1/Math.sqrt(s)),t[0]=e[0]*s,t[1]=e[1]*s,t[2]=e[2]*s,t}var I,D=function(t,e,i){return t[0]=e[0]-i[0],t[1]=e[1]-i[1],t[2]=e[2]-i[2],t};!function(){var t=S()}(),function(t){t[t.Rotating=0]="Rotating",t[t.Random=1]="Random"}(I||(I={}));class k{constructor(){this._speed=0,this.duration=0,this._minDuration=3e3,this._timer=0,this.lastTime=0,this._reverse=!1,this._cameraPosition=S(),this._cameraRotation=S(),this._matrix=x()}get cameraPosition(){return this._cameraPosition}get cameraRotation(){return this._cameraRotation}set reverse(t){this._reverse=t}set minDuration(t){this._minDuration=t}get matrix(){return this._matrix}get speed(){return this._speed}set speed(t){this._speed=t}get position(){return this._position}set position(t){this._position=t,this.duration=Math.max(this.getLength()/this.speed,this._minDuration)}get timer(){return this._timer}getLength(){if(void 0===this.position)return 0;const t=this.position.start.position,e=this.position.end.position;return Math.sqrt(Math.pow(e[0]-t[0],2)+Math.pow(e[1]-t[1],2)+Math.pow(e[2]-t[2],2))}iterate(t){if(0!=this.lastTime){const e=t-this.lastTime;this._timer+=e/this.duration,this._timer>1&&(this._timer=1)}this.lastTime=t,this.updateMatrix()}reset(){this._timer=0,this.updateMatrix()}updateMatrix(){if(void 0===this._position)return;const t=this._reverse?this._position.end:this._position.start,e=this._reverse?this._position.start:this._position.end;this._cameraPosition[0]=t.position[0]+this._timer*(e.position[0]-t.position[0]),this._cameraPosition[1]=t.position[1]+this._timer*(e.position[1]-t.position[1]),this._cameraPosition[2]=t.position[2]+this._timer*(e.position[2]-t.position[2]),this._cameraRotation[0]=t.rotation[0]+this._timer*(e.rotation[0]-t.rotation[0]),this._cameraRotation[1]=t.rotation[1]+this._timer*(e.rotation[1]-t.rotation[1]),this._cameraRotation[2]=t.rotation[2]+this._timer*(e.rotation[2]-t.rotation[2]),b(this.matrix),C(this.matrix,this.matrix,this._cameraRotation[0]-Math.PI/2),M(this.matrix,this.matrix,this._cameraRotation[1]),w(this.matrix,this.matrix,this._cameraRotation[2]),T(this.matrix,this.matrix,[-this._cameraPosition[0],-this._cameraPosition[1],-this._cameraPosition[2]])}}const N=x(),U=(t,e,i,r,n,s,o,a,h)=>{b(N),function(t,e,i,r){var n,s,o,a,h,l,d,c,u,f,m,g,_,p,x,v,b,E,A,T,R,C,w,M,y=r[0],F=r[1],S=r[2],O=Math.hypot(y,F,S);O<1e-6||(y*=O=1/O,F*=O,S*=O,n=Math.sin(i),o=1-(s=Math.cos(i)),a=e[0],h=e[1],l=e[2],d=e[3],c=e[4],u=e[5],f=e[6],m=e[7],g=e[8],_=e[9],p=e[10],x=e[11],v=y*y*o+s,b=F*y*o+S*n,E=S*y*o-F*n,A=y*F*o-S*n,T=F*F*o+s,R=S*F*o+y*n,C=y*S*o+F*n,w=F*S*o-y*n,M=S*S*o+s,t[0]=a*v+c*b+g*E,t[1]=h*v+u*b+_*E,t[2]=l*v+f*b+p*E,t[3]=d*v+m*b+x*E,t[4]=a*A+c*T+g*R,t[5]=h*A+u*T+_*R,t[6]=l*A+f*T+p*R,t[7]=d*A+m*T+x*R,t[8]=a*C+c*w+g*M,t[9]=h*C+u*w+_*M,t[10]=l*C+f*w+p*M,t[11]=d*C+m*w+x*M,e!==t&&(t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]))}(N,N,0,[1,0,0]),T(N,N,[t,e,i]),R(N,N,[o,a,h]),C(N,N,r),w(N,N,n),M(N,N,s)},L=[0,0,0];function G(t,e,i){const r=2*Math.PI*t,n=7*r,s=19*r,o=4*r,a=8*r;let h=120+16*Math.sin(n)+3*Math.sin(s);h+=e;let l=1*Math.sin(o)+3*Math.sin(a);return l+=7,L[0]=Math.sin(r)*h,L[1]=Math.cos(r)*h,L[2]=l,void 0!==i&&(i[0]=L[0],i[1]=L[1],i[2]=L[2]),L}let V=[];function B(t,e,i,r=0,n=[0,1]){V=[];const s=[];!function(t,e,i,r){for(let n=0;n<e;n++){let s=Math.random()-.5;s>0&&s<i&&(s+=i),s<0&&s>-i&&(s-=i);const[o,a,h]=G(n/e,s*r);t.push([o,a,h])}}(V,t,e,i);const o=new Float32Array(6*V.length);for(let t=0;t<V.length;t++){let[e,i,a]=V[t];a=r;const h=n[0]+Math.random()*n[1];o[3*t+0]=e,o[3*t+1]=i,o[3*t+2]=h;const l=Math.random()*Math.PI*2;o[3*t+0+3*V.length]=Math.sin(l),o[3*t+1+3*V.length]=Math.cos(l),o[3*t+2+3*V.length]=0,U(e,i,a,0,0,l,h,h,h),s.push([...N])}return[o,V.length,s.flat()]}const[H,X]=B(40,0,40),[,,j]=B(97,.7,23,0,[.0055,.004]),[,,z]=B(119,.72,25,0,[.006,.004]),[,,$]=B(60,.75,60,0,[.012,.004]),[,,Y]=B(40,0,10,0,[.0055,.004]),[,,W]=B(70,0,300,0,[.0055,.004]),[,,K]=B(1360,0,60,0,[.003,.003]),[Z,J]=B(97,.7,23),[Q,q]=B(119,.72,25),[tt,et]=B(60,.75,60),[it,rt]=B(40,0,10),[nt,st]=B(70,0,30),[ot,at]=B(1360,0,60),ht=new k;ht.reverse=!0,ht.speed=1e3,ht.minDuration=2e4/1.3,ht.position={start:{position:new Float32Array([-21.162155151367188,257.8841247558594,45]),rotation:new Float32Array([.09479612112045288,3.1140060424804688,0])},end:{position:new Float32Array([13.270217895507812,-567.8276977539062,47]),rotation:new Float32Array([.09479612112045288,3.1140060424804688,0])}};const lt=new k;lt.reverse=!0,lt.speed=1e3,lt.minDuration=3e4/1.3,lt.position={start:{position:new Float32Array([-183.71414184570312,99.32198333740234,45]),rotation:new Float32Array([.17399953305721283,1.7340009212493896,0])},end:{position:new Float32Array([181.34555053710938,29.235549926757812,51]),rotation:new Float32Array([.17399953305721283,1.7340009212493896,0])}};const dt=new k;dt.reverse=!0,dt.speed=1e3,dt.minDuration=24e3/1.3,dt.position={start:{position:new Float32Array([-257.13592529296875,193.58749389648438,45]),rotation:new Float32Array([.13199906051158905,2.6340126991271973,0])},end:{position:new Float32Array([88.29415893554688,-352.470458984375,44]),rotation:new Float32Array([.13199906051158905,2.6340126991271973,0])}};const ct=new k;ct.reverse=!0,ct.speed=1e3,ct.minDuration=22e3/1.3,ct.position={start:{position:new Float32Array([-167.41603088378906,-272.6703796386719,44]),rotation:new Float32Array([.09000006318092346,.9119994640350342,0])},end:{position:new Float32Array([213.55006408691406,31.966976165771484,44]),rotation:new Float32Array([.09000006318092346,.9119994640350342,0])}};const ut=new k;ut.reverse=!0,ut.speed=1e3,ut.minDuration=27e3/1.3,ut.position={start:{position:new Float32Array([249.5919189453125,274.224365234375,45]),rotation:new Float32Array([.12599891424179077,4.177173137664795,0])},end:{position:new Float32Array([-359.8509216308594,-126.64541625976562,46]),rotation:new Float32Array([.03599891439080238,.9239869713783264,0])}};const ft=new k;ft.reverse=!0,ft.speed=1e3,ft.minDuration=28e3/1.3,ft.position={start:{position:new Float32Array([-293.573486328125,-56.97015380859375,44]),rotation:new Float32Array([.1500007063150406,1.7520021200180054,0])},end:{position:new Float32Array([204.3482666015625,-165.2449188232422,44]),rotation:new Float32Array([.1500007063150406,1.7520021200180054,0])}};const mt=[{positionInterpolator:ht,rotation:0},{positionInterpolator:lt,rotation:1.3},{positionInterpolator:dt,rotation:.4},{positionInterpolator:ct,rotation:2.4},{positionInterpolator:ut,rotation:5.2},{positionInterpolator:ft,rotation:1.3}],gt="\n    /** From https://thebookofshaders.com/10/ */\n    float random_vec2 (vec2 st) {\n        return fract(sin(dot(st.xy,vec2(12.9898, 78.233))) * 43758.5453123);\n    }\n\n    /** Optimized version of the same random() from The Book of Shaders */\n    float random (float st) {\n        return fract(sin(st) * 43758.5453123);\n    }\n    ",_t="\n    /** https://www.neilmendoza.com/glsl-rotation-about-an-arbitrary-axis/ */\n    mat4 rotationMatrix(vec3 axis, float angle)\n    {\n        // axis = normalize(axis);\n        float s = sin(angle);\n        float c = cos(angle);\n        float oc = 1.0 - c;\n        \n        return mat4(oc * axis.x * axis.x + c,           oc * axis.x * axis.y - axis.z * s,  oc * axis.z * axis.x + axis.y * s,  0.0,\n                    oc * axis.x * axis.y + axis.z * s,  oc * axis.y * axis.y + c,           oc * axis.y * axis.z - axis.x * s,  0.0,\n                    oc * axis.z * axis.x - axis.y * s,  oc * axis.y * axis.z + axis.x * s,  oc * axis.z * axis.z + c,           0.0,\n                    0.0,                                0.0,                                0.0,                                1.0);\n    }  \n\n    /** Optimized version to rotate only around Z axis */\n    mat4 rotationAroundZ(float angle)\n    {\n        float s = sin(angle);\n        float c = cos(angle);\n        \n        return mat4(c,  -s,   0.0, 0.0,\n                    s,   c,   0.0, 0.0,\n                    0.0, 0.0, 1.0, 0.0,\n                    0.0, 0.0, 0.0, 1.0);\n    }\n    ";class pt extends g{fillCode(){this.vertexShaderCode=`#version 300 es\n            precision highp float;\n\n            uniform mat4 view_proj_matrix;\n\n            uniform vec2 uScale; // x: base scale for models; y: max random additional scale\n            uniform sampler2D sPositions;\n            uniform int uPositionOffset;\n\n            out mediump vec2 vTexCoord;\n\n            in vec2 rm_TexCoord0;\n            in vec4 rm_Vertex;\n\n            ${gt}\n            ${_t}\n\n            const float PI2 = 6.28318530718;\n\n            void main(void)\n            {\n                ${pt.COMMON_TRANSFORMS}\n\n                gl_Position = view_proj_matrix * vertex;\n                vTexCoord = rm_TexCoord0;\n            }`,this.fragmentShaderCode="#version 300 es\n            precision mediump float;\n            uniform sampler2D sTexture;\n\n            in mediump vec2 vTexCoord;\n            out vec4 fragColor;\n\n            void main(void)\n            {\n                fragColor = texture(sTexture, vTexCoord);\n            }"}fillUniformsAttributes(){super.fillUniformsAttributes(),this.uScale=this.getUniform("uScale"),this.sPositions=this.getUniform("sPositions"),this.uPositionOffset=this.getUniform("uPositionOffset")}drawModel(t,e,i,r,n,s,o,a,h,l,d){if(void 0===this.rm_Vertex||void 0===this.rm_TexCoord0||void 0===this.view_proj_matrix)return;const c=t.gl;e.bindBuffers(c),c.enableVertexAttribArray(this.rm_Vertex),c.enableVertexAttribArray(this.rm_TexCoord0),c.vertexAttribPointer(this.rm_Vertex,3,c.HALF_FLOAT,!1,12,0),c.vertexAttribPointer(this.rm_TexCoord0,2,c.HALF_FLOAT,!1,12,6),t.calculateMVPMatrix(i,r,n,s,o,a,h,l,d),c.uniformMatrix4fv(this.view_proj_matrix,!1,t.getMVPMatrix()),c.drawElements(c.TRIANGLES,3*e.getNumIndices(),c.UNSIGNED_SHORT,0),t.checkGlError("VertexLitInstancedShader glDrawElements")}drawInstanced(t,e,i,r,n,s,o,a,h,l,d,c,u){if(void 0===this.rm_Vertex||void 0===this.rm_TexCoord0||void 0===this.view_proj_matrix)return;const f=t.gl;e.bindBuffers(f),f.enableVertexAttribArray(this.rm_Vertex),f.enableVertexAttribArray(this.rm_TexCoord0),f.vertexAttribPointer(this.rm_Vertex,3,f.HALF_FLOAT,!1,12,0),f.vertexAttribPointer(this.rm_TexCoord0,2,f.HALF_FLOAT,!1,12,6),t.calculateMVPMatrix(i,r,n,s,o,a,h,l,d),f.uniformMatrix4fv(this.view_proj_matrix,!1,t.getMVPMatrix()),f.uniform1i(this.uPositionOffset,c),f.drawElementsInstanced(f.TRIANGLES,3*e.getNumIndices(),f.UNSIGNED_SHORT,0,u),t.checkGlError("InstancedVegetationShader glDrawElements")}}pt.COMMON_TRANSFORMS="\n    vec4 vertex = rm_Vertex;\n    float fInstance = float(gl_InstanceID);\n    int x = uPositionOffset + gl_InstanceID;\n    vec4 translationAndScale = texelFetch(sPositions, ivec2(x, 0), 0); // xy=translation, z=scale\n    vec4 rotations = texelFetch(sPositions, ivec2(x, 1), 0); // x=sin a; y=cos a\n    vec2 translation = translationAndScale.xy;\n    float scale = uScale.x + translationAndScale.z * uScale.y;\n    float s = rotations.x;\n    float c = rotations.y;\n    mat4 rotationMatrix = mat4(\n        c,  -s,   0.0, 0.0,\n        s,   c,   0.0, 0.0,\n        0.0, 0.0, 1.0, 0.0,\n        0.0, 0.0, 0.0, 1.0\n    );\n\n    vertex *= rotationMatrix;\n    vertex *= vec4(scale, scale, scale, 1.0);\n    vertex.xy += translation;\n    ";class xt extends pt{fillCode(){super.fillCode(),this.fragmentShaderCode="#version 300 es\n            precision mediump float;\n            uniform sampler2D sTexture;\n            uniform vec4 color;\n\n            in mediump vec2 vTexCoord;\n            out vec4 fragColor;\n\n            void main(void)\n            {\n                fragColor = texture(sTexture, vTexCoord) * color;\n            }"}fillUniformsAttributes(){super.fillUniformsAttributes(),this.color=this.getUniform("color")}}var vt,bt;class Et extends xt{fillCode(){this.vertexShaderCode=`#version 300 es\n            precision highp float;\n\n            uniform mat4 view_proj_matrix;\n\n            uniform mat4 view_matrix;\n            uniform mat4 model_matrix;\n            out vec3 texCoord;\n\n            uniform vec2 uScale; // x: base scale for models; y: max random additional scale\n            uniform sampler2D sPositions;\n            uniform int uPositionOffset;\n\n            in vec2 rm_TexCoord0;\n            in vec4 rm_Vertex;\n\n            ${gt}\n            ${_t}\n\n            const float PI2 = 6.28318530718;\n\n            ${Et.FOG_VERTEX_UNIFORMS_VARYINGS}\n\n            void main(void)\n            {\n                ${pt.COMMON_TRANSFORMS}\n                vertex.z += rotations.x * heightOffset.x + heightOffset.y;\n\n                gl_Position = view_proj_matrix * vertex;\n                vTexCoord = rm_TexCoord0;\n\n                ${Et.FOG_VERTEX_MAIN}\n            }`,this.fragmentShaderCode=`#version 300 es\n            precision mediump float;\n            uniform sampler2D sTexture;\n            uniform vec4 color;\n\n            in mediump vec2 vTexCoord;\n            out vec4 fragColor;\n\n            ${Et.FOG_FRAGMENT_UNIFORMS_VARYINGS}\n\n            void main(void)\n            {\n                ${Et.FOG_FRAGMENT_MAIN}\n                vec4 diffuse = texture(sTexture, vTexCoord) * color;\n                fragColor = mix(diffuse, fogColor, fogAmount);\n            }`}fillUniformsAttributes(){super.fillUniformsAttributes(),this.fogStartDistance=this.getUniform("fogStartDistance"),this.fogDistance=this.getUniform("fogDistance"),this.heightFogParams=this.getUniform("heightFogParams"),this.heightOffset=this.getUniform("heightOffset"),this.view_matrix=this.getUniform("view_matrix"),this.texCubemap=this.getUniform("texCubemap")}}vt=Et,Et.FOG_VERTEX_UNIFORMS_VARYINGS="\n        uniform vec2 heightOffset; // x: random positive/negative offset; y: fixed offset\n        uniform float fogDistance;\n        uniform float fogStartDistance;\n        out float vFogAmount;\n        out float vFogZ;\n        out mediump vec2 vTexCoord;\n        const float ZERO = 0.0;\n        const float ONE = 1.0;\n    ",Et.FOG_FRAGMENT_UNIFORMS_VARYINGS="\n        in float vFogAmount;\n        in float vFogZ;\n        uniform vec2 heightFogParams;\n        in vec3 texCoord;\n        uniform samplerCube texCubemap;\n        const float ZERO = 0.0;\n        const float ONE = 1.0;\n    ",Et.FOG_AMOUNT_VERTEX="\n        float distanceFog = clamp((length(gl_Position) - fogStartDistance) / fogDistance, ZERO, ONE);\n        vFogAmount = clamp(distanceFog, ZERO, ONE);\n    ",Et.FOG_VERTEX_MAIN=`\n        ${vt.FOG_AMOUNT_VERTEX}\n        vFogZ = vertex.z;\n        texCoord = inverse(mat3(view_matrix)) * (view_matrix * vertex).xyz;\n    `,Et.FOG_AMOUNT_FRAGMENT="\n        float heightFog = clamp(1.0 - ((vFogZ + heightFogParams.x) * heightFogParams.y), ZERO, ONE);\n        float fogAmount = clamp(vFogAmount + heightFog, ZERO, ONE);\n    ",Et.FOG_FRAGMENT_MAIN=`\n        ${vt.FOG_AMOUNT_FRAGMENT}\n        vec4 fogColor = texture(texCubemap, texCoord);\n    `;class At extends Et{fillCode(){super.fillCode(),this.fragmentShaderCode=`#version 300 es\n            precision mediump float;\n            uniform sampler2D sTexture;\n            uniform vec4 color;\n\n            in mediump vec2 vTexCoord;\n            out vec4 fragColor;\n\n            ${Et.FOG_FRAGMENT_UNIFORMS_VARYINGS}\n\n            void main(void)\n            {\n                ${Et.FOG_FRAGMENT_MAIN}\n                vec4 diffuse = texture(sTexture, vTexCoord) * color;\n                if (diffuse.a < 0.5) {\n                    discard;\n                } else {\n                    fragColor = mix(diffuse, fogColor, fogAmount);\n                }\n            }`}}class Tt extends n{fillCode(){this.vertexShaderCode="#version 300 es\n            precision highp float;\n            uniform mat4 view_proj_matrix;\n            in vec4 rm_Vertex;\n            out vec3 texCoord;\n            uniform mat4 view_matrix;\n\n            void main() {\n                gl_Position = view_proj_matrix * rm_Vertex;\n                vec4 p = view_matrix * rm_Vertex;\n                texCoord = inverse(mat3(view_matrix)) * p.xyz;\n            }",this.fragmentShaderCode="#version 300 es\n            precision mediump float;\n            in vec3 texCoord;\n            out vec4 color;\n            uniform samplerCube texCubemap;\n\n            void main(void) {\n                color = texture(texCubemap, texCoord);\n            }\n        "}fillUniformsAttributes(){this.view_proj_matrix=this.getUniform("view_proj_matrix"),this.view_matrix=this.getUniform("view_matrix"),this.texCubemap=this.getUniform("texCubemap"),this.rm_Vertex=this.getAttrib("rm_Vertex")}drawModel(t,e,i,r,n,s,o,a,h,l,d){if(void 0===this.rm_Vertex||void 0===this.view_proj_matrix||void 0===this.view_matrix||void 0===this.texCubemap)return;const c=t.gl;e.bindBuffers(c),c.enableVertexAttribArray(this.rm_Vertex),c.vertexAttribPointer(this.rm_Vertex,3,c.FLOAT,!1,20,0),t.calculateMVPMatrix(i,r,n,s,o,a,h,l,d),c.uniformMatrix4fv(this.view_proj_matrix,!1,t.getMVPMatrix()),c.uniformMatrix4fv(this.view_matrix,!1,t.getViewMatrix()),c.drawElements(c.TRIANGLES,3*e.getNumIndices(),c.UNSIGNED_SHORT,0),t.checkGlError("SkyShader glDrawElements")}}class Rt extends n{fillCode(){this.vertexShaderCode=`#version 300 es\n            precision highp float;\n            uniform highp mat4 uMVPMatrix;\n            in highp vec4 aPosition1;\n            in highp vec4 aPosition2;\n            uniform float m;\n            in highp vec2 aTextureCoord;\n            out mediump vec2 vTextureCoord;\n            uniform vec2 uSeed;\n\n            ${Et.FOG_VERTEX_UNIFORMS_VARYINGS}\n            out vec3 texCoord;\n            uniform mat4 view_matrix;\n            uniform mat4 model_matrix;\n            ${gt}\n\n            void main() {\n              float fInstance = float(gl_InstanceID);\n              vec4 vertex = mix(aPosition1, aPosition2, m);\n              float r1 = random(fInstance + uSeed.x);\n              float r2 = random(fInstance + uSeed.y);\n              vec3 translation = vec3(\n                150. * r1,\n                300. * r2,\n                42. * r1\n              );\n              vertex.xyz += translation;\n              gl_Position = uMVPMatrix * vertex;\n              vTextureCoord = aTextureCoord;\n              vertex = model_matrix * vertex;\n              ${Et.FOG_VERTEX_MAIN}\n            }`,this.fragmentShaderCode=`#version 300 es\n            precision mediump float;\n            in mediump vec2 vTextureCoord;\n            uniform sampler2D sTexture;\n            out vec4 fragColor;\n            uniform vec4 color;\n            ${Et.FOG_FRAGMENT_UNIFORMS_VARYINGS}\n\n            void main() {\n              ${Et.FOG_FRAGMENT_MAIN}\n              vec4 base = texture(sTexture, vTextureCoord);\n              if (base.a < 0.95) {\n                discard;\n              } else {\n                fragColor = mix(base * color, fogColor, fogAmount);\n              }\n            }`}fillUniformsAttributes(){this.maPosition1Handle=this.getAttrib("aPosition1"),this.maPosition2Handle=this.getAttrib("aPosition2"),this.maTextureHandle=this.getAttrib("aTextureCoord"),this.muMVPMatrixHandle=this.getUniform("uMVPMatrix"),this.msTextureHandle=this.getUniform("sTexture"),this.mMHandle=this.getUniform("m"),this.uSeed=this.getUniform("uSeed"),this.color=this.getUniform("color"),this.fogStartDistance=this.getUniform("fogStartDistance"),this.fogDistance=this.getUniform("fogDistance"),this.heightFogParams=this.getUniform("heightFogParams"),this.view_matrix=this.getUniform("view_matrix"),this.model_matrix=this.getUniform("model_matrix"),this.texCubemap=this.getUniform("texCubemap")}clamp(t,e,i){return Math.max(Math.min(t,i),e)}drawModel(t,e,i,r,n,s,o,a,h,l,d,c,u,f,m){if(void 0===this.muMVPMatrixHandle||void 0===this.msTextureHandle||void 0===this.mMHandle||void 0===this.maPosition1Handle||void 0===this.maPosition2Handle||void 0===this.maTextureHandle)return;const g=t.gl;e.bindBuffers(g);const _=4*(2+3*i),p=3*i*4;g.enableVertexAttribArray(this.maPosition1Handle),g.enableVertexAttribArray(this.maPosition2Handle),g.enableVertexAttribArray(this.maTextureHandle),g.vertexAttribPointer(this.maPosition1Handle,3,g.FLOAT,!1,_,3*r*4),g.vertexAttribPointer(this.maPosition2Handle,3,g.FLOAT,!1,_,3*n*4),g.vertexAttribPointer(this.maTextureHandle,2,g.FLOAT,!1,_,p),t.calculateMVPMatrix(o,a,h,l,d,c,u,f,m),g.uniformMatrix4fv(this.muMVPMatrixHandle,!1,t.getMVPMatrix()),g.uniform1f(this.mMHandle,this.clamp(s,0,1)),g.drawElements(g.TRIANGLES,3*e.getNumIndices(),g.UNSIGNED_SHORT,0),t.checkGlError("glDrawElements")}drawInstanced(t,e,i,r,n,s,o,a,h,l,d,c,u,f,m,g){if(void 0===this.muMVPMatrixHandle||void 0===this.msTextureHandle||void 0===this.mMHandle||void 0===this.maPosition1Handle||void 0===this.maPosition2Handle||void 0===this.maTextureHandle)return;const _=t.gl;e.bindBuffers(_);const p=4*(2+3*i),x=3*i*4;_.enableVertexAttribArray(this.maPosition1Handle),_.enableVertexAttribArray(this.maPosition2Handle),_.enableVertexAttribArray(this.maTextureHandle),_.vertexAttribPointer(this.maPosition1Handle,3,_.FLOAT,!1,p,3*r*4),_.vertexAttribPointer(this.maPosition2Handle,3,_.FLOAT,!1,p,3*n*4),_.vertexAttribPointer(this.maTextureHandle,2,_.FLOAT,!1,p,x),t.calculateMVPMatrix(o,a,h,l,d,c,u,f,m),_.uniformMatrix4fv(this.muMVPMatrixHandle,!1,t.getMVPMatrix()),_.uniformMatrix4fv(this.model_matrix,!1,t.getModelMatrix()),_.uniform1f(this.mMHandle,this.clamp(s,0,1)),_.drawElementsInstanced(_.TRIANGLES,3*e.getNumIndices(),_.UNSIGNED_SHORT,0,g),t.checkGlError("glDrawElementsInstanced")}}class Ct extends Et{fillCode(){this.vertexShaderCode=`#version 300 es\n            precision highp float;\n\n            uniform mat4 view_proj_matrix;\n\n            uniform mat4 view_matrix;\n            uniform mat4 model_matrix;\n            out vec3 texCoord;\n\n            uniform vec2 uScale; // x: base scale for models; y: max random additional scale\n            uniform sampler2D sPositions;\n            uniform int uPositionOffset;\n\n            in vec2 rm_TexCoord0;\n            in vec4 rm_Vertex;\n            in vec3 rm_Normal;\n\n            ${gt}\n            ${_t}\n\n            const float PI2 = 6.28318530718;\n\n            ${Et.FOG_VERTEX_UNIFORMS_VARYINGS}\n\n            uniform vec4 color;\n            uniform vec4 colorSun;\n            uniform vec4 lightDir;\n            uniform float diffuseExponent;\n            out vec4 vDiffuseColor;\n\n            void main(void)\n            {\n                ${pt.COMMON_TRANSFORMS}\n                vertex.z += rotations.x * heightOffset.x + heightOffset.y;\n\n                gl_Position = view_proj_matrix * vertex;\n                vTexCoord = rm_TexCoord0;\n\n                ${Et.FOG_VERTEX_MAIN}\n\n                vec4 normal = vec4(rm_Normal, 0.0) * rotationMatrix;\n                float d = pow(max(0.0, dot(normal, lightDir)), diffuseExponent);\n\n                vDiffuseColor = mix(colorSun, color, d);\n            }`,this.fragmentShaderCode=`#version 300 es\n            precision mediump float;\n            uniform sampler2D sTexture;\n\n            in mediump vec2 vTexCoord;\n            out vec4 fragColor;\n\n            ${Et.FOG_FRAGMENT_UNIFORMS_VARYINGS}\n\n            in vec4 vDiffuseColor;\n\n            void main(void)\n            {\n                ${Et.FOG_FRAGMENT_MAIN}\n                vec4 diffuse = texture(sTexture, vTexCoord) * vDiffuseColor;\n                fragColor = mix(diffuse, fogColor, fogAmount);\n            }`}fillUniformsAttributes(){super.fillUniformsAttributes(),this.colorSun=this.getUniform("colorSun"),this.lightDir=this.getUniform("lightDir"),this.diffuseExponent=this.getUniform("diffuseExponent"),this.rm_Normal=this.getAttrib("rm_Normal")}drawInstanced(t,e,i,r,n,s,o,a,h,l,d,c,u){if(void 0===this.rm_Vertex||void 0===this.rm_TexCoord0||void 0===this.rm_Normal||void 0===this.view_proj_matrix||void 0===this.view_matrix)return;const f=t.gl;e.bindBuffers(f),f.enableVertexAttribArray(this.rm_Vertex),f.enableVertexAttribArray(this.rm_TexCoord0),f.enableVertexAttribArray(this.rm_Normal),f.vertexAttribPointer(this.rm_Vertex,3,f.HALF_FLOAT,!1,16,0),f.vertexAttribPointer(this.rm_TexCoord0,2,f.HALF_FLOAT,!1,16,6),f.vertexAttribPointer(this.rm_Normal,3,f.HALF_FLOAT,!1,16,10),t.calculateMVPMatrix(i,r,n,s,o,a,h,l,d),f.uniformMatrix4fv(this.view_proj_matrix,!1,t.getMVPMatrix()),f.uniformMatrix4fv(this.view_matrix,!1,t.getViewMatrix()),f.uniform1i(this.uPositionOffset,c),f.drawElementsInstanced(f.TRIANGLES,3*e.getNumIndices(),f.UNSIGNED_SHORT,0,u),t.checkGlError("InstancedVegetationShader glDrawElements")}}class wt extends Ct{fillCode(){this.vertexShaderCode=`#version 300 es\n            precision highp float;\n\n            uniform mat4 view_proj_matrix;\n\n            uniform mat4 view_matrix;\n            uniform mat4 model_matrix;\n            out vec3 texCoord;\n\n            uniform vec2 uScale; // x: base scale for models; y: max random additional scale\n            uniform sampler2D sPositions;\n            uniform int uPositionOffset;\n\n            in vec2 rm_TexCoord0;\n            in vec4 rm_Vertex;\n            in vec3 rm_Normal;\n\n            ${gt}\n            ${_t}\n\n            const float PI2 = 6.28318530718;\n\n            ${Et.FOG_VERTEX_UNIFORMS_VARYINGS}\n\n            uniform vec4 color;\n            uniform vec4 colorSun;\n            uniform vec4 lightDir;\n            uniform float diffuseExponent;\n            out vec4 vDiffuseColor;\n            out float vGrass;\n            uniform float grassAmount;\n\n            void main(void)\n            {\n                ${pt.COMMON_TRANSFORMS}\n                vertex.z += rotations.x * heightOffset.x + heightOffset.y;\n\n                gl_Position = view_proj_matrix * vertex;\n                vTexCoord = rm_TexCoord0;\n\n                ${Et.FOG_VERTEX_MAIN}\n\n                vec4 normal = vec4(rm_Normal, 0.0) * rotationMatrix;\n\n                float d = pow(max(0.0, dot(normal, lightDir)), diffuseExponent);\n\n                vDiffuseColor = mix(colorSun, color, d);\n                vGrass = smoothstep(0.2, 0.3, normal.z * grassAmount);\n            }`,this.fragmentShaderCode=`#version 300 es\n            precision mediump float;\n            uniform sampler2D sTexture;\n            uniform sampler2D sTextureGrass;\n\n            in mediump vec2 vTexCoord;\n            out vec4 fragColor;\n\n            ${Et.FOG_FRAGMENT_UNIFORMS_VARYINGS}\n\n            in vec4 vDiffuseColor;\n            in float vGrass;\n\n            void main(void)\n            {\n                ${Et.FOG_FRAGMENT_MAIN}\n                vec4 rock = texture(sTexture, vTexCoord);\n                vec4 grass = texture(sTextureGrass, vTexCoord * 5.0);\n                vec4 mixed = mix(rock, grass, vGrass);\n                vec4 diffuse = mixed * vDiffuseColor;\n                fragColor = mix(diffuse, fogColor, fogAmount);\n                // fragColor.rgb = texCoord;\n            }`}fillUniformsAttributes(){super.fillUniformsAttributes(),this.sTextureGrass=this.getUniform("sTextureGrass"),this.grassAmount=this.getUniform("grassAmount")}}class Mt extends g{fillCode(){super.fillCode(),this.vertexShaderCode=`#version 300 es\n            precision highp float;\n\n            uniform mat4 view_proj_matrix;\n            uniform mat4 view_matrix;\n            uniform mat4 model_matrix;\n            out vec3 texCoord;\n\n            in vec2 rm_TexCoord0;\n            in vec4 rm_Vertex;\n\n            ${Et.FOG_VERTEX_UNIFORMS_VARYINGS}\n\n            void main(void)\n            {\n                vec4 vertex = model_matrix * rm_Vertex;\n                gl_Position = view_proj_matrix * rm_Vertex;\n                vTexCoord = rm_TexCoord0;\n                ${Et.FOG_VERTEX_MAIN}\n            }`,this.fragmentShaderCode=`#version 300 es\n            precision mediump float;\n            uniform sampler2D sTexture;\n            uniform vec4 color;\n\n            in mediump vec2 vTexCoord;\n            out vec4 fragColor;\n\n            uniform vec2 uCameraRange;\n            uniform vec2 uInvViewportSize;\n            uniform float uTransitionSize;\n            float calc_depth(in float z)\n            {\n              return (2.0 * uCameraRange.x) / (uCameraRange.y + uCameraRange.x - z*(uCameraRange.y - uCameraRange.x));\n            }\n            uniform sampler2D sDepth;\n            const float NEAR_SMOOTH_FADE = 0.03;\n\n            ${Et.FOG_FRAGMENT_UNIFORMS_VARYINGS}\n\n            void main(void)\n            {\n                vec2 coords = gl_FragCoord.xy * uInvViewportSize; // calculate depth texture coordinates\n                float geometryZ = calc_depth(texture(sDepth, coords).r); // lineriarize particle depth\n                float sceneZ = calc_depth(gl_FragCoord.z); // lineriarize scene depth\n                float a = clamp(geometryZ - sceneZ, 0.0, 1.0); // linear clamped diff between scene and particle depth\n                float b = smoothstep(0.0, uTransitionSize, a); // apply smoothstep to make soft transition\n\n                ${Et.FOG_AMOUNT_FRAGMENT}\n                vec4 diffuse = texture(sTexture, vTexCoord).rrrr * color;\n                b *= smoothstep(ZERO, NEAR_SMOOTH_FADE, sceneZ); // smooth fade out right before near clipping plane\n                fragColor = diffuse * (ONE - fogAmount) * b;\n            }`}fillUniformsAttributes(){super.fillUniformsAttributes(),this.fogStartDistance=this.getUniform("fogStartDistance"),this.fogDistance=this.getUniform("fogDistance"),this.heightFogParams=this.getUniform("heightFogParams"),this.model_matrix=this.getUniform("model_matrix"),this.color=this.getUniform("color"),this.cameraRange=this.getUniform("uCameraRange"),this.sDepth=this.getUniform("sDepth"),this.invViewportSize=this.getUniform("uInvViewportSize"),this.transitionSize=this.getUniform("uTransitionSize")}}class yt extends n{constructor(t){super(t),this.extBvbi=this.gl.getExtension("WEBGL_draw_instanced_base_vertex_base_instance")}fillCode(){this.vertexShaderCode=`#version 300 es\n            precision highp float;\n\n            ${yt.COMMON_UNIFORMS_ATTRIBUTES}\n\n            in mediump vec2 rm_TexCoord0;\n            in vec4 rm_Vertex;\n            out mediump vec2 vTexCoord;\n\n            void main(void) {\n                ${yt.COMMON_TRANSFORMS}\n\n                gl_Position = view_proj_matrix * rm_Vertex;\n                vTexCoord = rm_TexCoord0;\n            }`,this.fragmentShaderCode="#version 300 es\n            precision mediump float;\n            uniform sampler2D sTexture;\n\n            in mediump vec2 vTexCoord;\n            out vec4 fragColor;\n\n            void main(void) {\n                fragColor = texture(sTexture, vTexCoord);\n                // fragColor.r = 1.; // FIXME\n            }"}fillUniformsAttributes(){this.viewMatrix=this.getUniform("viewMatrix"),this.projMatrix=this.getUniform("projMatrix"),this.modelMatrix=this.getAttrib("modelMatrix"),this.sTexture=this.getUniform("sTexture"),this.rm_TexCoord0=this.getAttrib("rm_TexCoord0"),this.rm_Vertex=this.getAttrib("rm_Vertex")}drawModel(t,e,i){if(void 0===this.rm_Vertex||void 0===this.rm_TexCoord0||void 0===this.modelMatrix)return;const r=this.gl;e.bindBuffers(r),r.enableVertexAttribArray(this.rm_Vertex),r.enableVertexAttribArray(this.rm_TexCoord0),r.vertexAttribPointer(this.rm_Vertex,3,r.HALF_FLOAT,!1,12,0),r.vertexAttribPointer(this.rm_TexCoord0,2,r.HALF_FLOAT,!1,12,6),r.bindBuffer(r.ARRAY_BUFFER,i);for(let t=0;t<4;++t){const e=this.modelMatrix+t;r.enableVertexAttribArray(e);const i=16*t;r.vertexAttribPointer(e,4,r.FLOAT,!1,64,i),r.vertexAttribDivisor(e,1)}r.uniformMatrix4fv(this.viewMatrix,!1,t.getViewMatrix()),r.uniformMatrix4fv(this.projMatrix,!1,t.getProjectionMatrix()),r.drawElements(r.TRIANGLES,3*e.getNumIndices(),r.UNSIGNED_SHORT,0);for(let t=0;t<4;++t){const e=this.modelMatrix+t;r.vertexAttribDivisor(e,0)}t.checkGlError("VertexLitInstancedShader glDrawElements")}drawAllInstances(t,e,i,r){if(void 0===this.rm_Vertex||void 0===this.rm_TexCoord0||void 0===this.modelMatrix)return;const n=t.gl;e.bindBuffers(n),n.enableVertexAttribArray(this.rm_Vertex),n.enableVertexAttribArray(this.rm_TexCoord0),n.vertexAttribPointer(this.rm_Vertex,3,n.HALF_FLOAT,!1,12,0),n.vertexAttribPointer(this.rm_TexCoord0,2,n.HALF_FLOAT,!1,12,6),n.bindBuffer(n.ARRAY_BUFFER,i);for(let t=0;t<4;++t){const e=this.modelMatrix+t;n.enableVertexAttribArray(e);const i=16*t;n.vertexAttribPointer(e,4,n.FLOAT,!1,64,i),n.vertexAttribDivisor(e,1)}t.calculateMVPMatrix(0,0,0,0,0,0,1,1,1),n.uniformMatrix4fv(this.viewMatrix,!1,t.getViewMatrix()),n.uniformMatrix4fv(this.projMatrix,!1,t.getProjectionMatrix()),n.drawElementsInstanced(n.TRIANGLES,3*e.getNumIndices(),n.UNSIGNED_SHORT,0,r);for(let t=0;t<4;++t){const e=this.modelMatrix+t;n.vertexAttribDivisor(e,0)}t.checkGlError("InstancedShader drawAllInstances")}drawInstanced(t,e,i,r,n){if(void 0===this.rm_Vertex||void 0===this.rm_TexCoord0||void 0===this.modelMatrix||!this.extBvbi)return;const s=t.gl;e.bindBuffers(s),s.enableVertexAttribArray(this.rm_Vertex),s.enableVertexAttribArray(this.rm_TexCoord0),s.vertexAttribPointer(this.rm_Vertex,3,s.HALF_FLOAT,!1,12,0),s.vertexAttribPointer(this.rm_TexCoord0,2,s.HALF_FLOAT,!1,12,6),s.bindBuffer(s.ARRAY_BUFFER,i);for(let t=0;t<4;++t){const e=this.modelMatrix+t;s.enableVertexAttribArray(e);const i=16*t;s.vertexAttribPointer(e,4,s.FLOAT,!1,64,i),s.vertexAttribDivisor(e,1)}t.calculateMVPMatrix(0,0,0,0,0,0,1,1,1),s.uniformMatrix4fv(this.viewMatrix,!1,t.getViewMatrix()),s.uniformMatrix4fv(this.projMatrix,!1,t.getProjectionMatrix());const o=3*e.getNumIndices(),a=n;this.extBvbi.drawElementsInstancedBaseVertexBaseInstanceWEBGL(s.TRIANGLES,o,s.UNSIGNED_SHORT,0,a,0,r);for(let t=0;t<4;++t){const e=this.modelMatrix+t;s.vertexAttribDivisor(e,0)}t.checkGlError("InstancedShader glDrawElements")}}yt.COMMON_UNIFORMS_ATTRIBUTES="\n        uniform mat4 viewMatrix;\n        uniform mat4 projMatrix;\n        in mat4 modelMatrix;\n    ",yt.COMMON_TRANSFORMS="\n        mat4 view_proj_matrix = projMatrix * viewMatrix * modelMatrix;\n    ";class Ft extends yt{fillCode(){super.fillCode(),this.fragmentShaderCode="#version 300 es\n            precision mediump float;\n            uniform sampler2D sTexture;\n\n            in mediump vec2 vTexCoord;\n            out vec4 fragColor;\n\n            uniform vec4 color;\n\n            void main(void) {\n                fragColor = texture(sTexture, vTexCoord) * color;\n            }"}fillUniformsAttributes(){super.fillUniformsAttributes(),this.color=this.getUniform("color")}}class St extends Ft{fillCode(){this.vertexShaderCode=`#version 300 es\n            precision highp float;\n\n            in vec2 rm_TexCoord0;\n            in vec4 rm_Vertex;\n\n            ${yt.COMMON_UNIFORMS_ATTRIBUTES}\n            ${St.FOG_VERTEX_UNIFORMS_VARYINGS}\n\n            void main(void) {\n                vec4 vertex = modelMatrix * rm_Vertex;\n                // GLSL is column-major: mat[col][row]\n                // modelMatrix[0][1] is sine of model rotation angle\n                vertex.z += modelMatrix[0][1] * heightOffset.x + heightOffset.y;\n\n                gl_Position = projMatrix * viewMatrix * vertex;\n                vTexCoord = rm_TexCoord0;\n\n                ${St.FOG_VERTEX_MAIN}\n            }`,this.fragmentShaderCode=`#version 300 es\n            precision mediump float;\n            uniform sampler2D sTexture;\n            uniform vec4 color;\n\n            in mediump vec2 vTexCoord;\n            out vec4 fragColor;\n\n            ${St.FOG_FRAGMENT_UNIFORMS_VARYINGS}\n\n            void main(void) {\n                ${St.FOG_FRAGMENT_MAIN}\n                vec4 diffuse = texture(sTexture, vTexCoord) * color;\n                fragColor = mix(diffuse, fogColor, fogAmount);\n            }`}fillUniformsAttributes(){super.fillUniformsAttributes(),this.fogStartDistance=this.getUniform("fogStartDistance"),this.fogDistance=this.getUniform("fogDistance"),this.heightFogParams=this.getUniform("heightFogParams"),this.heightOffset=this.getUniform("heightOffset"),this.texCubemap=this.getUniform("texCubemap")}}bt=St,St.FOG_VERTEX_UNIFORMS_VARYINGS="\n        uniform vec2 heightOffset; // x: random positive/negative offset; y: fixed offset\n        uniform float fogDistance;\n        uniform float fogStartDistance;\n        out float vFogAmount;\n        out float vFogZ;\n        out vec3 texCoord;\n        out mediump vec2 vTexCoord;\n        const float ZERO = 0.0;\n        const float ONE = 1.0;\n    ",St.FOG_FRAGMENT_UNIFORMS_VARYINGS="\n        in float vFogAmount;\n        in float vFogZ;\n        uniform vec2 heightFogParams;\n        in vec3 texCoord;\n        uniform samplerCube texCubemap;\n        const float ZERO = 0.0;\n        const float ONE = 1.0;\n    ",St.FOG_AMOUNT_VERTEX="\n        float distanceFog = clamp((length(gl_Position) - fogStartDistance) / fogDistance, ZERO, ONE);\n        vFogAmount = clamp(distanceFog, ZERO, ONE);\n    ",St.FOG_VERTEX_MAIN=`\n        ${bt.FOG_AMOUNT_VERTEX}\n        vFogZ = vertex.z;\n        texCoord = inverse(mat3(viewMatrix)) * (viewMatrix * vertex).xyz;\n    `,St.FOG_AMOUNT_FRAGMENT="\n        float heightFog = clamp(1.0 - ((vFogZ + heightFogParams.x) * heightFogParams.y), ZERO, ONE);\n        float fogAmount = clamp(vFogAmount + heightFog, ZERO, ONE);\n    ",St.FOG_FRAGMENT_MAIN=`\n        ${bt.FOG_AMOUNT_FRAGMENT}\n        vec4 fogColor = texture(texCubemap, texCoord);\n    `;class Ot extends St{fillCode(){super.fillCode(),this.fragmentShaderCode=`#version 300 es\n            precision mediump float;\n            uniform sampler2D sTexture;\n            uniform vec4 color;\n\n            in mediump vec2 vTexCoord;\n            out vec4 fragColor;\n\n            ${St.FOG_FRAGMENT_UNIFORMS_VARYINGS}\n\n            void main(void) {\n                ${St.FOG_FRAGMENT_MAIN}\n                vec4 diffuse = texture(sTexture, vTexCoord) * color;\n                if (diffuse.a < 0.5) {\n                    discard;\n                } else {\n                    fragColor = mix(diffuse, fogColor, fogAmount);\n                }\n            }`}}class Pt extends St{fillCode(){this.vertexShaderCode=`#version 300 es\n            precision highp float;\n\n            in vec2 rm_TexCoord0;\n            in vec4 rm_Vertex;\n            in vec3 rm_Normal;\n\n            ${yt.COMMON_UNIFORMS_ATTRIBUTES}\n            ${St.FOG_VERTEX_UNIFORMS_VARYINGS}\n\n            uniform vec4 color;\n            uniform vec4 colorSun;\n            uniform vec4 lightDir;\n            uniform float diffuseExponent;\n            out vec4 vDiffuseColor;\n            out float vGrass;\n            uniform float grassAmount;\n\n            void main(void) {\n                vec4 vertex = modelMatrix * rm_Vertex;\n                // GLSL is column-major: mat[col][row]\n                // modelMatrix[0][1] is sine of model rotation angle\n                vertex.z += modelMatrix[0][1] * heightOffset.x + heightOffset.y;\n\n                gl_Position = projMatrix * viewMatrix * vertex;\n                vTexCoord = rm_TexCoord0;\n\n                ${St.FOG_VERTEX_MAIN}\n\n                vec4 normal = normalize(modelMatrix * vec4(rm_Normal, 0.0));\n\n                float d = pow(max(0.0, dot(normal, lightDir)), diffuseExponent);\n\n                vDiffuseColor = mix(colorSun, color, d);\n                vGrass = smoothstep(0.2, 0.3, normal.z * grassAmount);\n            }`,this.fragmentShaderCode=`#version 300 es\n            precision mediump float;\n            uniform sampler2D sTexture;\n            uniform vec4 color;\n\n            in mediump vec2 vTexCoord;\n            out vec4 fragColor;\n\n            uniform sampler2D sTextureGrass;\n            in vec4 vDiffuseColor;\n            in float vGrass;\n\n            ${St.FOG_FRAGMENT_UNIFORMS_VARYINGS}\n\n            void main(void) {\n                ${St.FOG_FRAGMENT_MAIN}\n                vec4 rock = texture(sTexture, vTexCoord);\n                vec4 grass = texture(sTextureGrass, vTexCoord * 5.0);\n                vec4 mixed = mix(rock, grass, vGrass);\n                vec4 diffuse = mixed * vDiffuseColor;\n                fragColor = mix(diffuse, fogColor, fogAmount);\n            }`}fillUniformsAttributes(){super.fillUniformsAttributes(),this.colorSun=this.getUniform("colorSun"),this.lightDir=this.getUniform("lightDir"),this.diffuseExponent=this.getUniform("diffuseExponent"),this.rm_Normal=this.getAttrib("rm_Normal"),this.sTextureGrass=this.getUniform("sTextureGrass"),this.grassAmount=this.getUniform("grassAmount")}drawInstanced(t,e,i,r,n){if(void 0===this.rm_Vertex||void 0===this.rm_TexCoord0||void 0===this.rm_Normal||void 0===this.modelMatrix||!this.extBvbi)return;const s=t.gl;e.bindBuffers(s),s.enableVertexAttribArray(this.rm_Vertex),s.enableVertexAttribArray(this.rm_TexCoord0),s.enableVertexAttribArray(this.rm_Normal),s.vertexAttribPointer(this.rm_Vertex,3,s.HALF_FLOAT,!1,16,0),s.vertexAttribPointer(this.rm_TexCoord0,2,s.HALF_FLOAT,!1,16,6),s.vertexAttribPointer(this.rm_Normal,3,s.HALF_FLOAT,!1,16,10),s.bindBuffer(s.ARRAY_BUFFER,i);for(let t=0;t<4;++t){const e=this.modelMatrix+t;s.enableVertexAttribArray(e);const i=16*t;s.vertexAttribPointer(e,4,s.FLOAT,!1,64,i),s.vertexAttribDivisor(e,1)}t.calculateMVPMatrix(0,0,0,0,0,0,1,1,1),s.uniformMatrix4fv(this.viewMatrix,!1,t.getViewMatrix()),s.uniformMatrix4fv(this.projMatrix,!1,t.getProjectionMatrix());const o=3*e.getNumIndices(),a=n;this.extBvbi.drawElementsInstancedBaseVertexBaseInstanceWEBGL(s.TRIANGLES,o,s.UNSIGNED_SHORT,0,a,0,r);for(let t=0;t<4;++t){const e=this.modelMatrix+t;s.vertexAttribDivisor(e,0)}t.checkGlError("InstancedShader glDrawElements")}}class It extends class{constructor(){this.mMMatrix=o(),this.mVMatrix=o(),this.mMVPMatrix=o(),this.mProjMatrix=o(),this.matOrtho=o(),this.m_boundTick=this.tick.bind(this),this.isWebGL2=!1,this.viewportWidth=0,this.viewportHeight=0}get gl(){if(void 0===this.m_gl)throw new Error("No WebGL context");return this.m_gl}logGLError(){var t=this.gl.getError();t!==this.gl.NO_ERROR&&console.warn(`WebGL error # + ${t}`)}setTexture2D(t,e,i){this.gl.activeTexture(this.gl.TEXTURE0+t),this.gl.bindTexture(this.gl.TEXTURE_2D,e),this.gl.uniform1i(i,t)}setTextureCubemap(t,e,i){this.gl.activeTexture(this.gl.TEXTURE0+t),this.gl.bindTexture(this.gl.TEXTURE_CUBE_MAP,e),this.gl.uniform1i(i,t)}setFOV(t,e,i,r,n){const s=Math.tan(e/360*Math.PI)*r,o=s*i;!function(t,e,i,r,n,s,o){var a=1/(i-e),h=1/(n-r),l=1/(s-o);t[0]=2*s*a,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=2*s*h,t[6]=0,t[7]=0,t[8]=(i+e)*a,t[9]=(n+r)*h,t[10]=(o+s)*l,t[11]=-1,t[12]=0,t[13]=0,t[14]=o*s*2*l,t[15]=0}(t,-o,o,-s,s,r,n)}calculateMVPMatrix(t,e,i,r,n,s,o,h,l){!function(t){t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1}(this.mMMatrix),function(t,e,i,r){var n,s,o,a,h,l,d,c,u,f,m,g,_,p,x,v,b,E,A,T,R,C,w,M,y=r[0],F=r[1],S=r[2],O=Math.hypot(y,F,S);O<1e-6||(y*=O=1/O,F*=O,S*=O,n=Math.sin(i),o=1-(s=Math.cos(i)),a=e[0],h=e[1],l=e[2],d=e[3],c=e[4],u=e[5],f=e[6],m=e[7],g=e[8],_=e[9],p=e[10],x=e[11],v=y*y*o+s,b=F*y*o+S*n,E=S*y*o-F*n,A=y*F*o-S*n,T=F*F*o+s,R=S*F*o+y*n,C=y*S*o+F*n,w=F*S*o-y*n,M=S*S*o+s,t[0]=a*v+c*b+g*E,t[1]=h*v+u*b+_*E,t[2]=l*v+f*b+p*E,t[3]=d*v+m*b+x*E,t[4]=a*A+c*T+g*R,t[5]=h*A+u*T+_*R,t[6]=l*A+f*T+p*R,t[7]=d*A+m*T+x*R,t[8]=a*C+c*w+g*M,t[9]=h*C+u*w+_*M,t[10]=l*C+f*w+p*M,t[11]=d*C+m*w+x*M,e!==t&&(t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]))}(this.mMMatrix,this.mMMatrix,0,[1,0,0]),function(t,e,i){var r,n,s,o,a,h,l,d,c,u,f,m,g=i[0],_=i[1],p=i[2];e===t?(t[12]=e[0]*g+e[4]*_+e[8]*p+e[12],t[13]=e[1]*g+e[5]*_+e[9]*p+e[13],t[14]=e[2]*g+e[6]*_+e[10]*p+e[14],t[15]=e[3]*g+e[7]*_+e[11]*p+e[15]):(r=e[0],n=e[1],s=e[2],o=e[3],a=e[4],h=e[5],l=e[6],d=e[7],c=e[8],u=e[9],f=e[10],m=e[11],t[0]=r,t[1]=n,t[2]=s,t[3]=o,t[4]=a,t[5]=h,t[6]=l,t[7]=d,t[8]=c,t[9]=u,t[10]=f,t[11]=m,t[12]=r*g+a*_+c*p+e[12],t[13]=n*g+h*_+u*p+e[13],t[14]=s*g+l*_+f*p+e[14],t[15]=o*g+d*_+m*p+e[15])}(this.mMMatrix,this.mMMatrix,[t,e,i]),function(t,e,i){var r=i[0],n=i[1],s=i[2];t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t[3]=e[3]*r,t[4]=e[4]*n,t[5]=e[5]*n,t[6]=e[6]*n,t[7]=e[7]*n,t[8]=e[8]*s,t[9]=e[9]*s,t[10]=e[10]*s,t[11]=e[11]*s,t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]}(this.mMMatrix,this.mMMatrix,[o,h,l]),function(t,e,i){var r=Math.sin(i),n=Math.cos(i),s=e[4],o=e[5],a=e[6],h=e[7],l=e[8],d=e[9],c=e[10],u=e[11];e!==t&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[4]=s*n+l*r,t[5]=o*n+d*r,t[6]=a*n+c*r,t[7]=h*n+u*r,t[8]=l*n-s*r,t[9]=d*n-o*r,t[10]=c*n-a*r,t[11]=u*n-h*r}(this.mMMatrix,this.mMMatrix,r),function(t,e,i){var r=Math.sin(i),n=Math.cos(i),s=e[0],o=e[1],a=e[2],h=e[3],l=e[8],d=e[9],c=e[10],u=e[11];e!==t&&(t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=s*n-l*r,t[1]=o*n-d*r,t[2]=a*n-c*r,t[3]=h*n-u*r,t[8]=s*r+l*n,t[9]=o*r+d*n,t[10]=a*r+c*n,t[11]=h*r+u*n}(this.mMMatrix,this.mMMatrix,n),function(t,e,i){var r=Math.sin(i),n=Math.cos(i),s=e[0],o=e[1],a=e[2],h=e[3],l=e[4],d=e[5],c=e[6],u=e[7];e!==t&&(t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=s*n+l*r,t[1]=o*n+d*r,t[2]=a*n+c*r,t[3]=h*n+u*r,t[4]=l*n-s*r,t[5]=d*n-o*r,t[6]=c*n-a*r,t[7]=u*n-h*r}(this.mMMatrix,this.mMMatrix,s),a(this.mMVPMatrix,this.mVMatrix,this.mMMatrix),a(this.mMVPMatrix,this.mProjMatrix,this.mMVPMatrix)}drawScene(){this.gl.viewport(0,0,this.gl.canvas.width,this.gl.canvas.height),this.gl.clearColor(0,0,0,1),this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT)}tick(){requestAnimationFrame(this.m_boundTick),this.resizeCanvas(),this.drawScene(),this.animate()}initGL(t){const e=t.getContext("webgl",{alpha:!1});if(null===e)throw new Error("Cannot initialize WebGL context");return e}initGL2(t){let e=t.getContext("webgl2",{alpha:!1});return null===e?(console.warn("Could not initialise WebGL 2, falling back to WebGL 1"),this.initGL(t)):e}generateMipmaps(...t){for(const e of t)this.gl.bindTexture(this.gl.TEXTURE_2D,e),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR_MIPMAP_LINEAR),this.gl.generateMipmap(this.gl.TEXTURE_2D)}init(t,e=!1){if(this.onBeforeInit(),this.canvas=document.getElementById(t),null===this.canvas)throw new Error("Cannot find canvas element");this.viewportWidth=this.canvas.width,this.viewportHeight=this.canvas.height,this.m_gl=e?this.initGL2(this.canvas):this.initGL(this.canvas),this.m_gl?(this.resizeCanvas(),this.onAfterInit(),this.initShaders(),this.loadData(),this.m_boundTick()):this.onInitError()}resizeCanvas(){if(void 0===this.canvas)return;const t=window.devicePixelRatio||1,e=Math.floor(this.canvas.clientWidth*t),i=Math.floor(this.canvas.clientHeight*t);this.canvas.width==e&&this.canvas.height==i||(this.canvas.width=e,this.canvas.height=i)}checkGlError(t){let e;for(;(e=this.gl.getError())!==this.gl.NO_ERROR;)console.error(`${t}: glError ${e}`)}unbindBuffers(){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,null),this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,null)}getMVPMatrix(){return this.mMVPMatrix}getOrthoMatrix(){return this.matOrtho}getModelMatrix(){return this.mMMatrix}getViewMatrix(){return this.mVMatrix}getProjectionMatrix(){return this.mProjMatrix}}{constructor(){super(),this.lastTime=0,this.loaded=!1,this.fmSky=new r,this.fmRock1=new r,this.fmRock1Grass=new r,this.fmRock2=new r,this.fmRock2Grass=new r,this.fmRock3=new r,this.fmRock3Grass=new r,this.fmTree=new r,this.fmBird=new r,this.fmSmoke=new r,this.noTextures=!1,this.noGlare=!1,this.textureOffscreenColor=null,this.textureOffscreenDepth=null,this.textureRocksPositions1=null,this.textureRocksPositions2=null,this.textureRocksPositions3=null,this.textureRocksPositions4=null,this.textureRocksPositions5=null,this.textureTreesPositions=null,this.bufferTreesMatrices=null,this.bufferRocks1Matrices=null,this.bufferRocks2Matrices=null,this.bufferRocks3Matrices=null,this.bufferRocks4Matrices=null,this.bufferRocks5Matrices=null,this.animationBird=new m(5),this.Z_NEAR=2,this.Z_FAR=1100,this.SMOKE_SOFTNESS=.012,this.timerCamera=0,this.SPLINE_CAMERA_PERIOD=166e3,this.timerFogThickness=0,this.FOG_THICKNESS_PERIOD=42e3,this.timerBirdAnimation1=0,this.BIRD_ANIMATION_PERIOD1=1200,this.timerRocksMovement=0,this.ROCKS_MOVEMENT_PERIOD=8e3,this.fogStartDistance=0,this.currentPreset=2,this.PRESETS=[{name:"Sunrise",cubemap:"sunrise1",lightDir:[0,1,0,1],diffuseExponent:.025,cloudsColor:[.17,.17,.17,1],colorSun:[1,167/255,53/255,1],colorAmbient:[93/255,81/255,112/255,1]},{name:"Day",cubemap:"day1",lightDir:[0,1,0,1],diffuseExponent:.025,cloudsColor:[.17,.17,.17,1],colorSun:[1,1,1,1],colorAmbient:[61/255,95/255,156/255,1]},{name:"Sunset",cubemap:"sunset1",lightDir:[0,1,0,1],diffuseExponent:.025,cloudsColor:[.17,.17,.17,1],colorSun:[1,.78,.2,1],colorAmbient:[.43,.45,.47,1]},{name:"Night",cubemap:"night1",lightDir:[0,1,0,1],diffuseExponent:.025,cloudsColor:[24/255,28/255,34/255,1],colorSun:[44/255,60/255,93/255,1],colorAmbient:[37/255,42/255,.2,1]}],this.cameraMode=I.Rotating,this.matViewInverted=x(),this.matViewInvertedTransposed=x(),this.matTemp=x(),this.cameraPosition=S(),this.cameraRotation=S(),this.tmpPosition1=[0,0,0],this.tmpPosition2=[0,0,0],this.tmpPosition3=[0,0,0],this.config={fogStartDistance:70,fogDistance:50,fogHeightOffset:2,fogHeightMultiplier:.08,heightOffset:10,treesHeightOffset:5.2,lightDir:[0,1,0,1],diffuseExponent:.025,grassAmount:1.5,cloudsColor:[.17,.17,.17,1],cloudsScale:.3,preset:2},this.v1=S(),this.v2=S(),this.v3=S()}setCustomCamera(t,e,i){this.customCamera=t,void 0!==e&&(this.cameraPosition=e),void 0!==i&&(this.cameraRotation=i)}resetCustomCamera(){this.customCamera=void 0}onBeforeInit(){}onAfterInit(){}onInitError(){var t,e;null===(t=document.getElementById("canvasGL"))||void 0===t||t.classList.add("hidden"),null===(e=document.getElementById("alertError"))||void 0===e||e.classList.remove("hidden")}initShaders(){this.shaderDiffuse=new g(this.gl),this.shaderFogVertexLitGrass=new wt(this.gl),this.shaderFogAt=new At(this.gl),this.shaderSky=new Tt(this.gl),this.shaderBirds=new Rt(this.gl),this.shaderFogSprite=new Mt(this.gl),this.extBvbi=this.gl.getExtension("WEBGL_multi_draw_instanced_base_vertex_base_instance"),this.extBvbi&&(console.log("Base vertex base index is available."),this.shaderInstancedFogAt=new Ot(this.gl),this.shaderInstancedRocks=new Pt(this.gl))}loadFp32Texture(t,e,i,r,n=e.LINEAR,s=e.LINEAR,o=!1,a=3){const h=e.createTexture();if(null===h)throw new Error("Error creating WebGL texture");let l=e.RGB32F,d=e.RGB;2===a?(l=e.RG32F,d=e.RG):1===a?(l=e.R32F,d=e.RED):4===a&&(l=e.RGBA32F,d=e.RGBA);const c=new Float32Array(t);return e.bindTexture(e.TEXTURE_2D,h),this.checkGlError("loadFp32Texture 0"),e.pixelStorei(e.UNPACK_ALIGNMENT,1),e.texImage2D(e.TEXTURE_2D,0,l,i,r,0,d,e.FLOAT,c),this.checkGlError("loadFp32Texture 1"),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,n),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,s),!0===o?(e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE)):(e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.REPEAT),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.REPEAT)),this.checkGlError("loadFp32Texture 2"),e.bindTexture(e.TEXTURE_2D,null),h}loadData(){var t;return _(this,void 0,void 0,(function*(){const e=this.PRESETS[this.currentPreset];this.initOffscreen(),this.initVignette();const r=this.gl;yield Promise.all([this.fmSky.load("data/models/sky",this.gl),this.fmRock1.load("data/models/rock-8",this.gl),this.fmRock2.load("data/models/rock-11",this.gl),this.fmRock3.load("data/models/rock-6",this.gl),this.fmTree.load("data/models/pinetree",this.gl),this.fmBird.load("data/models/bird-anim-uv",this.gl),this.fmRock1Grass.load("data/models/rock-8-grass",this.gl),this.fmRock2Grass.load("data/models/rock-11-grass",this.gl),this.fmRock3Grass.load("data/models/rock-6-grass",this.gl),this.fmSmoke.load("data/models/cloud",this.gl)]);const n=(t,e)=>this.loadFp32Texture(t,this.gl,e,2,this.gl.NEAREST,this.gl.NEAREST,!0,3);this.extBvbi?(this.bufferTreesMatrices=r.createBuffer(),r.bindBuffer(r.ARRAY_BUFFER,this.bufferTreesMatrices),r.bufferData(r.ARRAY_BUFFER,new Float32Array(K),r.STATIC_DRAW),this.bufferRocks1Matrices=r.createBuffer(),r.bindBuffer(r.ARRAY_BUFFER,this.bufferRocks1Matrices),r.bufferData(r.ARRAY_BUFFER,new Float32Array(j),r.STATIC_DRAW),this.bufferRocks2Matrices=r.createBuffer(),r.bindBuffer(r.ARRAY_BUFFER,this.bufferRocks2Matrices),r.bufferData(r.ARRAY_BUFFER,new Float32Array(z),r.STATIC_DRAW),this.bufferRocks3Matrices=r.createBuffer(),r.bindBuffer(r.ARRAY_BUFFER,this.bufferRocks3Matrices),r.bufferData(r.ARRAY_BUFFER,new Float32Array($),r.STATIC_DRAW),this.bufferRocks4Matrices=r.createBuffer(),r.bindBuffer(r.ARRAY_BUFFER,this.bufferRocks4Matrices),r.bufferData(r.ARRAY_BUFFER,new Float32Array(Y),r.STATIC_DRAW),this.bufferRocks5Matrices=r.createBuffer(),r.bindBuffer(r.ARRAY_BUFFER,this.bufferRocks5Matrices),r.bufferData(r.ARRAY_BUFFER,new Float32Array(W),r.STATIC_DRAW)):(this.textureRocksPositions1=n(Z,J),this.textureRocksPositions2=n(Q,q),this.textureRocksPositions3=n(tt,et),this.textureRocksPositions4=n(it,rt),this.textureRocksPositions5=n(nt,st),this.textureTreesPositions=n(ot,at)),[this.textureRocks,this.textureTrees,this.textureFogCubemap,this.textureBirds,this.textureGrass,this.textureFern,this.textureCloud,this.textureWhite]=yield Promise.all([i.load("data/textures/rocks.webp",this.gl,void 0,void 0,!0),i.load("data/textures/pine_leaves.webp",this.gl,void 0,void 0,!0),i.loadCubemap(`data/textures/cubemaps/${e.cubemap}/sky`,this.gl,"webp"),i.load("data/textures/bird2.webp",this.gl,void 0,void 0,!0),i.load("data/textures/grass.webp",this.gl,void 0,void 0,!1),i.load("data/textures/fern.webp",this.gl,void 0,void 0,!1),i.load("data/textures/smoke.webp",this.gl),i.load("data/textures/white.webp",this.gl,void 0,void 0,!0)]),this.generateMipmaps(this.textureRocks,this.textureTrees,this.textureGrass,this.textureFern,this.textureCloud,this.textureBirds),this.loaded=!0,console.log("Loaded all assets"),null===(t=this.readyCallback)||void 0===t||t.call(this)}))}initOffscreen(){void 0!==this.canvas&&(null!==this.textureOffscreenColor&&this.gl.deleteTexture(this.textureOffscreenColor),null!==this.textureOffscreenDepth&&this.gl.deleteTexture(this.textureOffscreenDepth),this.textureOffscreenColor=f.createNpotTexture(this.gl,this.canvas.width,this.canvas.height,!1),this.textureOffscreenDepth=f.createDepthTexture(this.gl,this.canvas.width,this.canvas.height),this.fboOffscreen=new u(this.gl),this.fboOffscreen.textureHandle=this.textureOffscreenColor,this.fboOffscreen.depthTextureHandle=this.textureOffscreenDepth,this.fboOffscreen.width=this.canvas.width,this.fboOffscreen.height=this.canvas.height,this.fboOffscreen.createGLData(this.canvas.width,this.canvas.height),this.checkGlError("offscreen FBO"))}resizeCanvas(){if(void 0===this.canvas)return;const{width:t,height:e}=this.canvas;super.resizeCanvas(),this.canvas.width==t&&this.canvas.height==e||this.initOffscreen()}initVignette(){F(this.matOrtho,-1,1,-1,1,2,250),this.mQuadTriangles=new Float32Array([-1,-1,-5,0,0,1,-1,-5,1,0,-1,1,-5,0,1,1,1,-5,1,1]),this.mTriangleVerticesVignette=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.mTriangleVerticesVignette),this.gl.bufferData(this.gl.ARRAY_BUFFER,this.mQuadTriangles,this.gl.STATIC_DRAW)}changeScene(t){return _(this,void 0,void 0,(function*(){const e=null!=t?t:(this.currentPreset+1)%4,r=yield i.loadCubemap(`data/textures/cubemaps/${this.PRESETS[e].cubemap}/sky`,this.gl,"webp");this.gl.deleteTexture(this.textureFogCubemap),this.textureFogCubemap=r,this.currentPreset=e}))}animate(){const t=(new Date).getTime();0!=this.lastTime&&(this.timerCamera=this.cameraMode===I.Rotating?t%this.SPLINE_CAMERA_PERIOD/this.SPLINE_CAMERA_PERIOD:0,this.timerFogThickness=t%this.FOG_THICKNESS_PERIOD/this.FOG_THICKNESS_PERIOD,this.timerBirdAnimation1=t%this.BIRD_ANIMATION_PERIOD1/this.BIRD_ANIMATION_PERIOD1,this.timerRocksMovement=t%this.ROCKS_MOVEMENT_PERIOD/this.ROCKS_MOVEMENT_PERIOD),this.lastTime=t}setCameraFOV(t){var e;e=this.gl.canvas.height>0?this.gl.canvas.width/this.gl.canvas.height:1;let i=0;i=this.gl.canvas.width>=this.gl.canvas.height?60*t:70*t,this.setFOV(this.mProjMatrix,i,e,this.Z_NEAR,this.Z_FAR)}positionCamera(t){void 0===this.customCamera?(G(t,0,this.tmpPosition1),G(t+.02,0,this.tmpPosition2),G(t+.0205,0,this.tmpPosition3),this.cameraPosition[0]=this.tmpPosition1[0],this.cameraPosition[1]=this.tmpPosition1[1],this.cameraPosition[2]=this.tmpPosition1[2],D(this.v1,this.tmpPosition2,this.tmpPosition1),D(this.v2,this.tmpPosition3,this.tmpPosition1),P(this.v1,this.v1),P(this.v2,this.v2),function(t,e,i){var r=e[0],n=e[1],s=e[2],o=i[0],a=i[1],h=i[2];t[0]=n*h-s*a,t[1]=s*o-r*h,t[2]=r*a-n*o}(this.v3,this.v1,this.v2),function(t,e,i,r){var n,s,o,a,h,l,d,c,u,f,m=e[0],g=e[1],_=e[2],p=r[0],x=r[1],v=r[2],E=i[0],A=i[1],T=i[2];Math.abs(m-E)<1e-6&&Math.abs(g-A)<1e-6&&Math.abs(_-T)<1e-6?b(t):(d=m-E,c=g-A,u=_-T,n=x*(u*=f=1/Math.hypot(d,c,u))-v*(c*=f),s=v*(d*=f)-p*u,o=p*c-x*d,(f=Math.hypot(n,s,o))?(n*=f=1/f,s*=f,o*=f):(n=0,s=0,o=0),a=c*o-u*s,h=u*n-d*o,l=d*s-c*n,(f=Math.hypot(a,h,l))?(a*=f=1/f,h*=f,l*=f):(a=0,h=0,l=0),t[0]=n,t[1]=a,t[2]=d,t[3]=0,t[4]=s,t[5]=h,t[6]=c,t[7]=0,t[8]=o,t[9]=l,t[10]=u,t[11]=0,t[12]=-(n*m+s*g+o*_),t[13]=-(a*m+h*g+l*_),t[14]=-(d*m+c*g+u*_),t[15]=1)}(this.mVMatrix,this.tmpPosition1,this.tmpPosition2,[0,-6*this.v3[2],1])):this.mVMatrix=this.customCamera}drawScene(){this.loaded&&(this.positionCamera(this.timerCamera),this.setCameraFOV(1),this.gl.clearColor(0,0,0,0),this.gl.enable(this.gl.DEPTH_TEST),this.gl.enable(this.gl.CULL_FACE),this.gl.cullFace(this.gl.BACK),this.gl.colorMask(!0,!0,!0,!0),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.fboOffscreen.framebufferHandle),this.gl.viewport(0,0,this.fboOffscreen.width,this.fboOffscreen.height),this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT),this.drawOffscreenObjects(),this.gl.clearColor(0,0,0,0),this.cameraMode===I.Random&&this.gl.clearColor(1,0,1,1),this.positionCamera(this.timerCamera),this.setCameraFOV(1),this.gl.colorMask(!0,!0,!0,!0),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null),this.gl.viewport(0,0,this.gl.canvas.width,this.gl.canvas.height),this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT),this.drawSceneObjects())}drawTestDepth(){this.gl.enable(this.gl.CULL_FACE),this.gl.cullFace(this.gl.BACK),this.gl.disable(this.gl.BLEND),this.shaderDiffuse.use(),this.setTexture2D(0,this.textureOffscreenDepth,this.shaderDiffuse.sTexture),this.drawVignette(this.shaderDiffuse)}drawVignette(t){this.unbindBuffers(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.mTriangleVerticesVignette),this.gl.enableVertexAttribArray(t.rm_Vertex),this.gl.vertexAttribPointer(t.rm_Vertex,3,this.gl.FLOAT,!1,20,0),this.gl.enableVertexAttribArray(t.rm_TexCoord0),this.gl.vertexAttribPointer(t.rm_TexCoord0,2,this.gl.FLOAT,!1,20,12),this.gl.uniformMatrix4fv(t.view_proj_matrix,!1,this.getOrthoMatrix()),this.gl.drawArrays(this.gl.TRIANGLE_STRIP,0,4)}drawOffscreenObjects(){this.drawRocks()}drawSceneObjects(){void 0!==this.shaderDiffuse?(this.gl.cullFace(this.gl.BACK),this.gl.disable(this.gl.BLEND),this.fogStartDistance=.666*this.config.fogStartDistance+.333*this.config.fogStartDistance*(.5*(Math.sin(2*Math.PI*this.timerFogThickness)+1)),this.drawRocks(),this.drawBirds(),this.gl.enable(this.gl.CULL_FACE),this.drawSkyObject(),this.gl.depthMask(!1),this.gl.enable(this.gl.BLEND),this.gl.blendFunc(this.gl.ONE,this.gl.ONE),this.drawClouds(),this.gl.disable(this.gl.BLEND),this.gl.depthMask(!0)):console.log("undefined shaders")}drawClouds(){if(void 0===this.shaderFogSprite)return void console.log("undefined shaders");const t=this.PRESETS[this.currentPreset];this.gl.enable(this.gl.CULL_FACE);const e=this.shaderFogSprite;e.use(),this.gl.uniform1f(e.fogStartDistance,this.fogStartDistance),this.gl.uniform1f(e.fogDistance,this.config.fogDistance),this.gl.uniform2f(e.heightFogParams,this.config.fogHeightOffset,this.config.fogHeightMultiplier),this.setTexture2D(0,this.textureCloud,e.sTexture),this.gl.uniform4fv(e.color,t.cloudsColor),this.gl.uniform2f(e.cameraRange,this.Z_NEAR,this.Z_FAR),this.gl.uniform2f(e.invViewportSize,1/this.gl.canvas.width,1/this.gl.canvas.height),this.gl.uniform1f(e.transitionSize,this.SMOKE_SOFTNESS),this.setTexture2D(1,this.textureOffscreenDepth,e.sDepth),this.drawCloudModels(e,this.fmSmoke,H,X,this.config.cloudsScale,0,[0,0,12])}drawRocks(){this.extBvbi?this.drawRocksBvbi():this.drawRocksWithTextures()}drawRocksWithTextures(){if(void 0===this.shaderFogVertexLitGrass||void 0===this.shaderFogAt||void 0===this.shaderFogSprite||void 0===this.shaderDiffuse)return void console.log("undefined shaders");const t=this.PRESETS[this.currentPreset];let e;this.gl.enable(this.gl.CULL_FACE),e=this.shaderFogAt,e.use(),this.gl.uniform1f(e.fogStartDistance,this.fogStartDistance),this.gl.uniform1f(e.fogDistance,this.config.fogDistance),this.gl.uniform2f(e.heightFogParams,this.config.fogHeightOffset,this.config.fogHeightMultiplier),this.setTexture2D(1,this.noTextures?this.textureWhite:this.textureTrees,e.sTexture),this.gl.uniformMatrix4fv(e.view_matrix,!1,this.getViewMatrix()),this.setTextureCubemap(2,this.textureFogCubemap,e.texCubemap),this.gl.uniform2f(e.heightOffset,0,-this.config.treesHeightOffset),this.drawInstances(e,this.fmTree,this.textureTreesPositions,at,[.003,.003],[0,0,0]),e=this.shaderFogVertexLitGrass,e.use(),this.gl.uniform1f(e.fogStartDistance,this.fogStartDistance),this.gl.uniform1f(e.fogDistance,this.config.fogDistance),this.gl.uniform2f(e.heightFogParams,this.config.fogHeightOffset,this.config.fogHeightMultiplier),this.setTexture2D(1,this.noTextures?this.textureWhite:this.textureRocks,e.sTexture),this.gl.uniformMatrix4fv(e.view_matrix,!1,this.getViewMatrix()),this.setTextureCubemap(2,this.textureFogCubemap,e.texCubemap),this.gl.uniform4fv(this.shaderFogVertexLitGrass.colorSun,t.colorSun),this.gl.uniform4fv(this.shaderFogVertexLitGrass.lightDir,t.lightDir),this.gl.uniform1f(this.shaderFogVertexLitGrass.diffuseExponent,this.config.diffuseExponent),this.gl.uniform1f(this.shaderFogVertexLitGrass.grassAmount,this.config.grassAmount),this.setTexture2D(3,this.noTextures?this.textureWhite:this.textureGrass,this.shaderFogVertexLitGrass.sTextureGrass),this.gl.uniform2f(e.heightOffset,this.config.heightOffset,.25*this.config.heightOffset),this.drawInstances(e,this.fmRock1,this.textureRocksPositions1,J,[.0055,.004]),this.drawInstances(e,this.fmRock2,this.textureRocksPositions2,q,[.006,.004]),this.gl.uniform2f(e.heightOffset,0,0),this.drawInstances(e,this.fmRock3,this.textureRocksPositions3,et,[.012,.004]);const i=6*Math.sin(this.timerRocksMovement*Math.PI*2);this.gl.uniform2f(e.heightOffset,i,34),this.drawInstances(e,this.fmRock1,this.textureRocksPositions4,rt,[.0055,.004]),this.gl.uniform2f(e.heightOffset,0,-14),this.drawInstances(e,this.fmRock1,this.textureRocksPositions5,st,[.0055,.004]),this.gl.disable(this.gl.CULL_FACE),e=this.shaderFogAt,e.use(),this.gl.uniform1f(e.fogStartDistance,this.fogStartDistance),this.gl.uniform1f(e.fogDistance,this.config.fogDistance),this.gl.uniform2f(e.heightFogParams,this.config.fogHeightOffset,this.config.fogHeightMultiplier),this.gl.uniformMatrix4fv(e.view_matrix,!1,this.getViewMatrix()),this.setTextureCubemap(2,this.textureFogCubemap,e.texCubemap),this.gl.uniform2f(e.heightOffset,0,-this.config.treesHeightOffset),this.setTexture2D(1,this.noTextures?this.textureWhite:this.textureFern,e.sTexture),this.gl.uniform2f(e.heightOffset,this.config.heightOffset,.25*this.config.heightOffset),this.drawInstances(e,this.fmRock1Grass,this.textureRocksPositions1,J,[.0055,.004]),this.drawInstances(e,this.fmRock2Grass,this.textureRocksPositions2,q,[.006,.004]),this.gl.uniform2f(e.heightOffset,0,0),this.drawInstances(e,this.fmRock3Grass,this.textureRocksPositions3,et,[.012,.004]),this.gl.uniform2f(e.heightOffset,i,34),this.drawInstances(e,this.fmRock1Grass,this.textureRocksPositions4,rt,[.0055,.004]),this.gl.uniform2f(e.heightOffset,0,-14),this.drawInstances(e,this.fmRock1Grass,this.textureRocksPositions5,st,[.0055,.004])}drawRocksBvbi(){if(void 0===this.shaderInstancedRocks||void 0===this.shaderInstancedFogAt)return;const t=this.PRESETS[this.currentPreset];this.gl.enable(this.gl.CULL_FACE),this.gl.disable(this.gl.CULL_FACE),this.shaderInstancedFogAt.use(),this.gl.uniform1f(this.shaderInstancedFogAt.fogStartDistance,this.fogStartDistance),this.gl.uniform1f(this.shaderInstancedFogAt.fogDistance,this.config.fogDistance),this.gl.uniform2f(this.shaderInstancedFogAt.heightFogParams,this.config.fogHeightOffset,this.config.fogHeightMultiplier),this.setTexture2D(0,this.noTextures?this.textureWhite:this.textureTrees,this.shaderInstancedFogAt.sTexture),this.setTextureCubemap(1,this.textureFogCubemap,this.shaderInstancedFogAt.texCubemap),this.gl.uniform2f(this.shaderInstancedFogAt.heightOffset,0,-this.config.treesHeightOffset),this.gl.uniform4fv(this.shaderInstancedFogAt.color,t.colorAmbient),this.drawInstances2(this.shaderInstancedFogAt,this.fmTree,this.bufferTreesMatrices,at),this.gl.enable(this.gl.CULL_FACE),this.shaderInstancedRocks.use(),this.gl.uniform1f(this.shaderInstancedRocks.fogStartDistance,this.fogStartDistance),this.gl.uniform1f(this.shaderInstancedRocks.fogDistance,this.config.fogDistance),this.gl.uniform2f(this.shaderInstancedRocks.heightFogParams,this.config.fogHeightOffset,this.config.fogHeightMultiplier),this.setTexture2D(0,this.noTextures?this.textureWhite:this.textureRocks,this.shaderInstancedRocks.sTexture),this.setTextureCubemap(1,this.textureFogCubemap,this.shaderInstancedRocks.texCubemap),this.gl.uniform4fv(this.shaderInstancedRocks.colorSun,t.colorSun),this.gl.uniform4fv(this.shaderInstancedRocks.color,t.colorAmbient),this.gl.uniform4fv(this.shaderInstancedRocks.lightDir,t.lightDir),this.gl.uniform1f(this.shaderInstancedRocks.diffuseExponent,this.config.diffuseExponent),this.gl.uniform1f(this.shaderInstancedRocks.grassAmount,this.config.grassAmount),this.setTexture2D(2,this.noTextures?this.textureWhite:this.textureGrass,this.shaderInstancedRocks.sTextureGrass),this.gl.uniform2f(this.shaderInstancedRocks.heightOffset,this.config.heightOffset/.0055,.25*this.config.heightOffset),this.drawInstances2(this.shaderInstancedRocks,this.fmRock1,this.bufferRocks1Matrices,J),this.gl.uniform2f(this.shaderInstancedRocks.heightOffset,this.config.heightOffset/.006,.25*this.config.heightOffset),this.drawInstances2(this.shaderInstancedRocks,this.fmRock2,this.bufferRocks2Matrices,q),this.gl.uniform2f(this.shaderInstancedRocks.heightOffset,0,0),this.drawInstances2(this.shaderInstancedRocks,this.fmRock3,this.bufferRocks3Matrices,et);const e=6*Math.sin(this.timerRocksMovement*Math.PI*2);this.gl.uniform2f(this.shaderInstancedRocks.heightOffset,e/.0055,34),this.drawInstances2(this.shaderInstancedRocks,this.fmRock1,this.bufferRocks4Matrices,rt),this.gl.uniform2f(this.shaderInstancedRocks.heightOffset,0,-14),this.drawInstances2(this.shaderInstancedRocks,this.fmRock1,this.bufferRocks5Matrices,st),this.gl.disable(this.gl.CULL_FACE),this.shaderInstancedFogAt.use(),this.gl.uniform1f(this.shaderInstancedFogAt.fogStartDistance,this.fogStartDistance),this.gl.uniform1f(this.shaderInstancedFogAt.fogDistance,this.config.fogDistance),this.gl.uniform2f(this.shaderInstancedFogAt.heightFogParams,this.config.fogHeightOffset,this.config.fogHeightMultiplier),this.setTexture2D(0,this.noTextures?this.textureWhite:this.textureFern,this.shaderInstancedFogAt.sTexture),this.setTextureCubemap(1,this.textureFogCubemap,this.shaderInstancedFogAt.texCubemap),this.gl.uniform2f(this.shaderInstancedFogAt.heightOffset,0,-this.config.treesHeightOffset),this.gl.uniform4fv(this.shaderInstancedFogAt.color,t.colorAmbient),this.gl.uniform2f(this.shaderInstancedFogAt.heightOffset,this.config.heightOffset/.0055,.25*this.config.heightOffset),this.drawInstances2(this.shaderInstancedFogAt,this.fmRock1Grass,this.bufferRocks1Matrices,J),this.gl.uniform2f(this.shaderInstancedFogAt.heightOffset,this.config.heightOffset/.006,.25*this.config.heightOffset),this.drawInstances2(this.shaderInstancedFogAt,this.fmRock2Grass,this.bufferRocks2Matrices,q),this.gl.uniform2f(this.shaderInstancedFogAt.heightOffset,0,0),this.drawInstances2(this.shaderInstancedFogAt,this.fmRock3Grass,this.bufferRocks3Matrices,et),this.gl.uniform2f(this.shaderInstancedFogAt.heightOffset,e/.0055,34),this.drawInstances2(this.shaderInstancedFogAt,this.fmRock1Grass,this.bufferRocks4Matrices,rt),this.gl.uniform2f(this.shaderInstancedFogAt.heightOffset,0,-14),this.drawInstances2(this.shaderInstancedFogAt,this.fmRock1Grass,this.bufferRocks5Matrices,st)}drawInstances(t,e,i,r,n,s=[0,0,0]){const o=this.PRESETS[this.currentPreset];this.setTexture2D(0,i,t.sPositions),this.gl.uniform4fv(t.color,o.colorAmbient),this.gl.uniform2fv(t.uScale,n);const a=Math.floor(r*(this.timerCamera-.05)),h=Math.floor(.25*r);a>0&&a+h<=r?t.drawInstanced(this,e,s[0],s[1],s[2],0,0,0,1,1,1,a,h):a<=0?(t.drawInstanced(this,e,s[0],s[1],s[2],0,0,0,1,1,1,r+a,-a),t.drawInstanced(this,e,s[0],s[1],s[2],0,0,0,1,1,1,0,h+a)):(t.drawInstanced(this,e,s[0],s[1],s[2],0,0,0,1,1,1,a,r-a),t.drawInstanced(this,e,s[0],s[1],s[2],0,0,0,1,1,1,0,h-(r-a)))}drawInstances2(t,e,i,r){this.PRESETS[this.currentPreset];const n=Math.floor(r*(this.timerCamera-.05)),s=Math.floor(.25*r);n>0&&n+s<=r?t.drawInstanced(this,e,i,n,s):n<=0?(t.drawInstanced(this,e,i,r+n,-n),t.drawInstanced(this,e,i,0,s+n)):(t.drawInstanced(this,e,i,n,r-n),t.drawInstanced(this,e,i,0,s-(r-n)))}drawCloudModels(t,e,i,r,n=1,s=0,o=[0,0,0]){const a=(r,a)=>{for(let h=r;h<r+a;h++){const r=i[3*h+0],a=i[3*h+1],l=i[3*h+2];this.drawDiffuseVBOFacingCamera(t,e,r+o[0],a+o[1],l+o[2],n,n,n,s)}},h=Math.floor(r*(this.timerCamera-.05)),l=Math.floor(.25*r);h>0&&h+l<=r?a(h,l):h<=0?(a(r+h,-h),a(0,l+h)):(a(h,r-h),a(0,l-(r-h)))}drawBirds(){const t=this.PRESETS[this.currentPreset];this.shaderBirds.use(),this.setTexture2D(0,this.noTextures?this.textureWhite:this.textureBirds,this.shaderBirds.msTextureHandle),this.setTextureCubemap(1,this.textureFogCubemap,this.shaderBirds.texCubemap),this.gl.uniform1f(this.shaderBirds.fogStartDistance,this.fogStartDistance),this.gl.uniform1f(this.shaderBirds.fogDistance,this.config.fogDistance),this.gl.uniform2f(this.shaderBirds.heightFogParams,this.config.fogHeightOffset,this.config.fogHeightMultiplier),this.gl.uniformMatrix4fv(this.shaderBirds.view_matrix,!1,this.getViewMatrix()),this.gl.uniform4fv(this.shaderBirds.color,t.colorSun);const e=(new Date).getTime();for(let t=0;t<mt.length;t++){const{positionInterpolator:i,rotation:r}=mt[t];i.iterate(e),i.timer>.99&&i.reset(),this.drawBirdsFlock(9,i.cameraPosition[0],i.cameraPosition[1],i.cameraPosition[2]-20,r,.4,1)}}drawBirdsFlock(t,e,i,r,n,s,o){var a,h;this.animationBird.animate(this.timerBirdAnimation1),this.gl.uniform2f(this.shaderBirds.uSeed,1.1*o,2.2*o),null===(a=this.shaderBirds)||void 0===a||a.drawInstanced(this,this.fmBird,this.animationBird.getFramesCount(),this.animationBird.getStart(),this.animationBird.getEnd(),this.animationBird.getCurrentCoeff(),e,i,r,0,0,n,s,s,s,t),this.animationBird.animate((this.timerBirdAnimation1+.3)%1),this.gl.uniform2f(this.shaderBirds.uSeed,12.5*o,13.5*o),null===(h=this.shaderBirds)||void 0===h||h.drawInstanced(this,this.fmBird,this.animationBird.getFramesCount(),this.animationBird.getStart(),this.animationBird.getEnd(),this.animationBird.getCurrentCoeff(),e,i,r,0,0,n,s,s,s,t)}drawSkyObject(){void 0!==this.shaderSky&&(this.shaderSky.use(),this.setTextureCubemap(0,this.textureFogCubemap,this.shaderSky.texCubemap),this.shaderSky.drawModel(this,this.fmSky,0,0,0,0,0,0,1,1,1))}toggleGlare(){this.noGlare=!this.noGlare}changeCameraMode(){this.cameraMode===I.Random?this.cameraMode=I.Rotating:this.cameraMode=I.Random}checkGlError(t){}set ready(t){this.readyCallback=t}drawDiffuseVBOFacingCamera(t,e,i,r,n,s,o,a,h){e.bindBuffers(this.gl),this.gl.enableVertexAttribArray(t.rm_Vertex),this.gl.enableVertexAttribArray(t.rm_TexCoord0),this.gl.vertexAttribPointer(t.rm_Vertex,3,this.gl.FLOAT,!1,20,0),this.gl.vertexAttribPointer(t.rm_TexCoord0,2,this.gl.FLOAT,!1,20,12),this.calculateMVPMatrixForSprite(i,r,n,s,o,a,h),this.gl.uniformMatrix4fv(t.view_proj_matrix,!1,this.mMVPMatrix),this.gl.uniformMatrix4fv(t.model_matrix,!1,this.getModelMatrix()),this.gl.drawElements(this.gl.TRIANGLES,3*e.getNumIndices(),this.gl.UNSIGNED_SHORT,0),this.checkGlError("glDrawElements")}calculateMVPMatrixForSprite(t,e,i,r,n,s,o){b(this.mMMatrix),T(this.mMMatrix,this.mMMatrix,[t,e,i]),R(this.mMMatrix,this.mMMatrix,[r,n,s]),A(this.mMVPMatrix,this.mVMatrix,this.mMMatrix),this.resetMatrixRotations(this.mMVPMatrix),M(this.mMVPMatrix,this.mMVPMatrix,o),A(this.mMVPMatrix,this.mProjMatrix,this.mMVPMatrix)}resetMatrixRotations(t){const e=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]);t[0]=e,t[4]=0,t[8]=0,t[1]=0,t[5]=e,t[9]=0,t[2]=0,t[6]=0,t[10]=e,t[3]=0,t[7]=0,t[11]=0,t[15]=1}}class Dt{constructor(t){var e,i;this._dirty=!0,this._angles=S(),this._position=S(),this.speed=100,this.rotationSpeed=.025,this._cameraMat=x(),this._viewMat=x(),this.projectionMat=x(),this.pressedKeys=new Array,this.canvas=t.canvas,this.speed=null!==(e=t.movementSpeed)&&void 0!==e?e:100,this.rotationSpeed=null!==(i=t.rotationSpeed)&&void 0!==i?i:.025;let r,n,s=!1;window.addEventListener("keydown",(t=>this.pressedKeys[t.keyCode]=!0)),window.addEventListener("keyup",(t=>this.pressedKeys[t.keyCode]=!1)),this.canvas.addEventListener("contextmenu",(t=>t.preventDefault())),this.canvas.addEventListener("mousedown",(t=>{3===t.which&&(s=!0),r=t.pageX,n=t.pageY})),this.canvas.addEventListener("mousemove",(t=>{if(s){let e=t.pageX-r,i=t.pageY-n;r=t.pageX,n=t.pageY,this.angles[1]+=e*this.rotationSpeed,this.angles[1]<0&&(this.angles[1]+=2*Math.PI),this.angles[1]>=2*Math.PI&&(this.angles[1]-=2*Math.PI),this.angles[0]+=i*this.rotationSpeed,this.angles[0]<.5*-Math.PI&&(this.angles[0]=.5*-Math.PI),this.angles[0]>.5*Math.PI&&(this.angles[0]=.5*Math.PI),this._dirty=!0}})),this.canvas.addEventListener("mouseup",(t=>s=!1))}get angles(){return this._angles}set angles(t){this._angles=t,this._dirty=!0}get position(){return this._position}set position(t){this._position=t,this._dirty=!0}get viewMat(){if(this._dirty){var t=this._viewMat;b(t),C(t,t,this.angles[0]-Math.PI/2),M(t,t,this.angles[1]),w(t,t,this.angles[2]),T(t,t,[-this.position[0],-this.position[1],-this.position[2]]),this._dirty=!1}return this._viewMat}update(t){const e=S();let i=this.speed/1e3*t;if(this.pressedKeys[16]&&(i*=5),this.pressedKeys["W".charCodeAt(0)]&&(e[1]+=i),this.pressedKeys["S".charCodeAt(0)]&&(e[1]-=i),this.pressedKeys["A".charCodeAt(0)]&&(e[0]-=i),this.pressedKeys["D".charCodeAt(0)]&&(e[0]+=i),this.pressedKeys[32]&&(e[2]+=i),this.pressedKeys["C".charCodeAt(0)]&&(e[2]-=i),0!==e[0]||0!==e[1]||0!==e[2]){let t=this._cameraMat;b(t),C(t,t,this.angles[0]),M(t,t,this.angles[1]),E(t,t),function(t,e,i){var r=e[0],n=e[1],s=e[2],o=i[3]*r+i[7]*n+i[11]*s+i[15];o=o||1,t[0]=(i[0]*r+i[4]*n+i[8]*s+i[12])/o,t[1]=(i[1]*r+i[5]*n+i[9]*s+i[13])/o,t[2]=(i[2]*r+i[6]*n+i[10]*s+i[14])/o}(e,e,t),function(t,e,i){t[0]=e[0]+i[0],t[1]=e[1]+i[1],t[2]=e[2]+i[2]}(this.position,this.position,e),this._dirty=!0}}}var kt;!function(t){t[t.Free=0]="Free",t[t.Predefined=1]="Predefined"}(kt||(kt={}));class Nt{constructor(t,e){this.renderer=t,this.options=e,this.matCamera=x(),this.matInvCamera=new Float32Array(16),this.vec3Eye=new Float32Array(3),this.vec3Rotation=new Float32Array(3),this.mode=kt.Predefined,this.setupControls()}setupControls(){document.addEventListener("dblclick",(t=>{var e;if(this.mode===kt.Predefined){this.matCamera=v(this.renderer.getViewMatrix()),this.renderer.setCustomCamera(this.matCamera),this.mode=kt.Free,E(this.matInvCamera,this.matCamera),y(this.vec3Eye,this.matInvCamera),P(this.vec3Rotation,this.vec3Eye),O(this.vec3Rotation,this.vec3Rotation,-1),this.fpsCamera=null!==(e=this.fpsCamera)&&void 0!==e?e:new Dt(this.options),this.fpsCamera.position=this.vec3Eye;const t=e=>{this.mode===kt.Free&&(this.fpsCamera.update(16),this.matCamera=this.fpsCamera.viewMat,this.renderer.setCustomCamera(this.matCamera,this.fpsCamera.position,this.fpsCamera.angles),requestAnimationFrame(t))};t()}else this.renderer.resetCustomCamera(),this.mode=kt.Predefined})),document.addEventListener("keypress",(t=>{var e;if("Enter"===t.code)if(this.mode===kt.Predefined){this.matCamera=v(this.renderer.getViewMatrix()),this.renderer.setCustomCamera(this.matCamera),this.mode=kt.Free,E(this.matInvCamera,this.matCamera),y(this.vec3Eye,this.matInvCamera),P(this.vec3Rotation,this.vec3Eye),O(this.vec3Rotation,this.vec3Rotation,-1),this.fpsCamera=null!==(e=this.fpsCamera)&&void 0!==e?e:new Dt(this.options),this.fpsCamera.position=this.vec3Eye;const t=e=>{this.mode===kt.Free&&(this.fpsCamera.update(16),this.matCamera=this.fpsCamera.viewMat,this.renderer.setCustomCamera(this.matCamera,this.fpsCamera.position,this.fpsCamera.angles),requestAnimationFrame(t))};t()}else this.renderer.resetCustomCamera(),this.mode=kt.Predefined}))}}function Ut(t,e){var i=t.__state.conversionName.toString(),r=Math.round(t.r),n=Math.round(t.g),s=Math.round(t.b),o=t.a,a=Math.round(t.h),h=t.s.toFixed(1),l=t.v.toFixed(1);if(e||"THREE_CHAR_HEX"===i||"SIX_CHAR_HEX"===i){for(var d=t.hex.toString(16);d.length<6;)d="0"+d;return"#"+d}return"CSS_RGB"===i?"rgb("+r+","+n+","+s+")":"CSS_RGBA"===i?"rgba("+r+","+n+","+s+","+o+")":"HEX"===i?"0x"+t.hex.toString(16):"RGB_ARRAY"===i?"["+r+","+n+","+s+"]":"RGBA_ARRAY"===i?"["+r+","+n+","+s+","+o+"]":"RGB_OBJ"===i?"{r:"+r+",g:"+n+",b:"+s+"}":"RGBA_OBJ"===i?"{r:"+r+",g:"+n+",b:"+s+",a:"+o+"}":"HSV_OBJ"===i?"{h:"+a+",s:"+h+",v:"+l+"}":"HSVA_OBJ"===i?"{h:"+a+",s:"+h+",v:"+l+",a:"+o+"}":"unknown format"}var Lt=Array.prototype.forEach,Gt=Array.prototype.slice,Vt={BREAK:{},extend:function(t){return this.each(Gt.call(arguments,1),(function(e){(this.isObject(e)?Object.keys(e):[]).forEach(function(i){this.isUndefined(e[i])||(t[i]=e[i])}.bind(this))}),this),t},defaults:function(t){return this.each(Gt.call(arguments,1),(function(e){(this.isObject(e)?Object.keys(e):[]).forEach(function(i){this.isUndefined(t[i])&&(t[i]=e[i])}.bind(this))}),this),t},compose:function(){var t=Gt.call(arguments);return function(){for(var e=Gt.call(arguments),i=t.length-1;i>=0;i--)e=[t[i].apply(this,e)];return e[0]}},each:function(t,e,i){if(t)if(Lt&&t.forEach&&t.forEach===Lt)t.forEach(e,i);else if(t.length===t.length+0){var r,n=void 0;for(n=0,r=t.length;n<r;n++)if(n in t&&e.call(i,t[n],n)===this.BREAK)return}else for(var s in t)if(e.call(i,t[s],s)===this.BREAK)return},defer:function(t){setTimeout(t,0)},debounce:function(t,e,i){var r=void 0;return function(){var n=this,s=arguments;function o(){r=null,i||t.apply(n,s)}var a=i||!r;clearTimeout(r),r=setTimeout(o,e),a&&t.apply(n,s)}},toArray:function(t){return t.toArray?t.toArray():Gt.call(t)},isUndefined:function(t){return void 0===t},isNull:function(t){return null===t},isNaN:function(t){function e(e){return t.apply(this,arguments)}return e.toString=function(){return t.toString()},e}((function(t){return isNaN(t)})),isArray:Array.isArray||function(t){return t.constructor===Array},isObject:function(t){return t===Object(t)},isNumber:function(t){return t===t+0},isString:function(t){return t===t+""},isBoolean:function(t){return!1===t||!0===t},isFunction:function(t){return t instanceof Function}},Bt=[{litmus:Vt.isString,conversions:{THREE_CHAR_HEX:{read:function(t){var e=t.match(/^#([A-F0-9])([A-F0-9])([A-F0-9])$/i);return null!==e&&{space:"HEX",hex:parseInt("0x"+e[1].toString()+e[1].toString()+e[2].toString()+e[2].toString()+e[3].toString()+e[3].toString(),0)}},write:Ut},SIX_CHAR_HEX:{read:function(t){var e=t.match(/^#([A-F0-9]{6})$/i);return null!==e&&{space:"HEX",hex:parseInt("0x"+e[1].toString(),0)}},write:Ut},CSS_RGB:{read:function(t){var e=t.match(/^rgb\(\s*(\S+)\s*,\s*(\S+)\s*,\s*(\S+)\s*\)/);return null!==e&&{space:"RGB",r:parseFloat(e[1]),g:parseFloat(e[2]),b:parseFloat(e[3])}},write:Ut},CSS_RGBA:{read:function(t){var e=t.match(/^rgba\(\s*(\S+)\s*,\s*(\S+)\s*,\s*(\S+)\s*,\s*(\S+)\s*\)/);return null!==e&&{space:"RGB",r:parseFloat(e[1]),g:parseFloat(e[2]),b:parseFloat(e[3]),a:parseFloat(e[4])}},write:Ut}}},{litmus:Vt.isNumber,conversions:{HEX:{read:function(t){return{space:"HEX",hex:t,conversionName:"HEX"}},write:function(t){return t.hex}}}},{litmus:Vt.isArray,conversions:{RGB_ARRAY:{read:function(t){return 3===t.length&&{space:"RGB",r:t[0],g:t[1],b:t[2]}},write:function(t){return[t.r,t.g,t.b]}},RGBA_ARRAY:{read:function(t){return 4===t.length&&{space:"RGB",r:t[0],g:t[1],b:t[2],a:t[3]}},write:function(t){return[t.r,t.g,t.b,t.a]}}}},{litmus:Vt.isObject,conversions:{RGBA_OBJ:{read:function(t){return!!(Vt.isNumber(t.r)&&Vt.isNumber(t.g)&&Vt.isNumber(t.b)&&Vt.isNumber(t.a))&&{space:"RGB",r:t.r,g:t.g,b:t.b,a:t.a}},write:function(t){return{r:t.r,g:t.g,b:t.b,a:t.a}}},RGB_OBJ:{read:function(t){return!!(Vt.isNumber(t.r)&&Vt.isNumber(t.g)&&Vt.isNumber(t.b))&&{space:"RGB",r:t.r,g:t.g,b:t.b}},write:function(t){return{r:t.r,g:t.g,b:t.b}}},HSVA_OBJ:{read:function(t){return!!(Vt.isNumber(t.h)&&Vt.isNumber(t.s)&&Vt.isNumber(t.v)&&Vt.isNumber(t.a))&&{space:"HSV",h:t.h,s:t.s,v:t.v,a:t.a}},write:function(t){return{h:t.h,s:t.s,v:t.v,a:t.a}}},HSV_OBJ:{read:function(t){return!!(Vt.isNumber(t.h)&&Vt.isNumber(t.s)&&Vt.isNumber(t.v))&&{space:"HSV",h:t.h,s:t.s,v:t.v}},write:function(t){return{h:t.h,s:t.s,v:t.v}}}}}],Ht=void 0,Xt=void 0,jt=function(){Xt=!1;var t=arguments.length>1?Vt.toArray(arguments):arguments[0];return Vt.each(Bt,(function(e){if(e.litmus(t))return Vt.each(e.conversions,(function(e,i){if(Ht=e.read(t),!1===Xt&&!1!==Ht)return Xt=Ht,Ht.conversionName=i,Ht.conversion=e,Vt.BREAK})),Vt.BREAK})),Xt},zt=void 0,$t={hsv_to_rgb:function(t,e,i){var r=Math.floor(t/60)%6,n=t/60-Math.floor(t/60),s=i*(1-e),o=i*(1-n*e),a=i*(1-(1-n)*e),h=[[i,a,s],[o,i,s],[s,i,a],[s,o,i],[a,s,i],[i,s,o]][r];return{r:255*h[0],g:255*h[1],b:255*h[2]}},rgb_to_hsv:function(t,e,i){var r=Math.min(t,e,i),n=Math.max(t,e,i),s=n-r,o=void 0;return 0===n?{h:NaN,s:0,v:0}:(o=t===n?(e-i)/s:e===n?2+(i-t)/s:4+(t-e)/s,(o/=6)<0&&(o+=1),{h:360*o,s:s/n,v:n/255})},rgb_to_hex:function(t,e,i){var r=this.hex_with_component(0,2,t);return r=this.hex_with_component(r,1,e),r=this.hex_with_component(r,0,i)},component_from_hex:function(t,e){return t>>8*e&255},hex_with_component:function(t,e,i){return i<<(zt=8*e)|t&~(255<<zt)}},Yt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Wt=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},Kt=function(){function t(t,e){for(var i=0;i<e.length;i++){var r=e[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,i,r){return i&&t(e.prototype,i),r&&t(e,r),e}}(),Zt=function t(e,i,r){null===e&&(e=Function.prototype);var n=Object.getOwnPropertyDescriptor(e,i);if(void 0===n){var s=Object.getPrototypeOf(e);return null===s?void 0:t(s,i,r)}if("value"in n)return n.value;var o=n.get;return void 0!==o?o.call(r):void 0},Jt=function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)},Qt=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e},qt=function(){function t(){if(Wt(this,t),this.__state=jt.apply(this,arguments),!1===this.__state)throw new Error("Failed to interpret color arguments");this.__state.a=this.__state.a||1}return Kt(t,[{key:"toString",value:function(){return Ut(this)}},{key:"toHexString",value:function(){return Ut(this,!0)}},{key:"toOriginal",value:function(){return this.__state.conversion.write(this)}}]),t}();function te(t,e,i){Object.defineProperty(t,e,{get:function(){return"RGB"===this.__state.space||qt.recalculateRGB(this,e,i),this.__state[e]},set:function(t){"RGB"!==this.__state.space&&(qt.recalculateRGB(this,e,i),this.__state.space="RGB"),this.__state[e]=t}})}function ee(t,e){Object.defineProperty(t,e,{get:function(){return"HSV"===this.__state.space||qt.recalculateHSV(this),this.__state[e]},set:function(t){"HSV"!==this.__state.space&&(qt.recalculateHSV(this),this.__state.space="HSV"),this.__state[e]=t}})}qt.recalculateRGB=function(t,e,i){if("HEX"===t.__state.space)t.__state[e]=$t.component_from_hex(t.__state.hex,i);else{if("HSV"!==t.__state.space)throw new Error("Corrupted color state");Vt.extend(t.__state,$t.hsv_to_rgb(t.__state.h,t.__state.s,t.__state.v))}},qt.recalculateHSV=function(t){var e=$t.rgb_to_hsv(t.r,t.g,t.b);Vt.extend(t.__state,{s:e.s,v:e.v}),Vt.isNaN(e.h)?Vt.isUndefined(t.__state.h)&&(t.__state.h=0):t.__state.h=e.h},qt.COMPONENTS=["r","g","b","h","s","v","hex","a"],te(qt.prototype,"r",2),te(qt.prototype,"g",1),te(qt.prototype,"b",0),ee(qt.prototype,"h"),ee(qt.prototype,"s"),ee(qt.prototype,"v"),Object.defineProperty(qt.prototype,"a",{get:function(){return this.__state.a},set:function(t){this.__state.a=t}}),Object.defineProperty(qt.prototype,"hex",{get:function(){return"HEX"!==this.__state.space&&(this.__state.hex=$t.rgb_to_hex(this.r,this.g,this.b),this.__state.space="HEX"),this.__state.hex},set:function(t){this.__state.space="HEX",this.__state.hex=t}});var ie=function(){function t(e,i){Wt(this,t),this.initialValue=e[i],this.domElement=document.createElement("div"),this.object=e,this.property=i,this.__onChange=void 0,this.__onFinishChange=void 0}return Kt(t,[{key:"onChange",value:function(t){return this.__onChange=t,this}},{key:"onFinishChange",value:function(t){return this.__onFinishChange=t,this}},{key:"setValue",value:function(t){return this.object[this.property]=t,this.__onChange&&this.__onChange.call(this,t),this.updateDisplay(),this}},{key:"getValue",value:function(){return this.object[this.property]}},{key:"updateDisplay",value:function(){return this}},{key:"isModified",value:function(){return this.initialValue!==this.getValue()}}]),t}(),re={};Vt.each({HTMLEvents:["change"],MouseEvents:["click","mousemove","mousedown","mouseup","mouseover"],KeyboardEvents:["keydown"]},(function(t,e){Vt.each(t,(function(t){re[t]=e}))}));var ne=/(\d+(\.\d+)?)px/;function se(t){if("0"===t||Vt.isUndefined(t))return 0;var e=t.match(ne);return Vt.isNull(e)?0:parseFloat(e[1])}var oe={makeSelectable:function(t,e){void 0!==t&&void 0!==t.style&&(t.onselectstart=e?function(){return!1}:function(){},t.style.MozUserSelect=e?"auto":"none",t.style.KhtmlUserSelect=e?"auto":"none",t.unselectable=e?"on":"off")},makeFullscreen:function(t,e,i){var r=i,n=e;Vt.isUndefined(n)&&(n=!0),Vt.isUndefined(r)&&(r=!0),t.style.position="absolute",n&&(t.style.left=0,t.style.right=0),r&&(t.style.top=0,t.style.bottom=0)},fakeEvent:function(t,e,i,r){var n=i||{},s=re[e];if(!s)throw new Error("Event type "+e+" not supported.");var o=document.createEvent(s);switch(s){case"MouseEvents":var a=n.x||n.clientX||0,h=n.y||n.clientY||0;o.initMouseEvent(e,n.bubbles||!1,n.cancelable||!0,window,n.clickCount||1,0,0,a,h,!1,!1,!1,!1,0,null);break;case"KeyboardEvents":var l=o.initKeyboardEvent||o.initKeyEvent;Vt.defaults(n,{cancelable:!0,ctrlKey:!1,altKey:!1,shiftKey:!1,metaKey:!1,keyCode:void 0,charCode:void 0}),l(e,n.bubbles||!1,n.cancelable,window,n.ctrlKey,n.altKey,n.shiftKey,n.metaKey,n.keyCode,n.charCode);break;default:o.initEvent(e,n.bubbles||!1,n.cancelable||!0)}Vt.defaults(o,r),t.dispatchEvent(o)},bind:function(t,e,i,r){var n=r||!1;return t.addEventListener?t.addEventListener(e,i,n):t.attachEvent&&t.attachEvent("on"+e,i),oe},unbind:function(t,e,i,r){var n=r||!1;return t.removeEventListener?t.removeEventListener(e,i,n):t.detachEvent&&t.detachEvent("on"+e,i),oe},addClass:function(t,e){if(void 0===t.className)t.className=e;else if(t.className!==e){var i=t.className.split(/ +/);-1===i.indexOf(e)&&(i.push(e),t.className=i.join(" ").replace(/^\s+/,"").replace(/\s+$/,""))}return oe},removeClass:function(t,e){if(e)if(t.className===e)t.removeAttribute("class");else{var i=t.className.split(/ +/),r=i.indexOf(e);-1!==r&&(i.splice(r,1),t.className=i.join(" "))}else t.className=void 0;return oe},hasClass:function(t,e){return new RegExp("(?:^|\\s+)"+e+"(?:\\s+|$)").test(t.className)||!1},getWidth:function(t){var e=getComputedStyle(t);return se(e["border-left-width"])+se(e["border-right-width"])+se(e["padding-left"])+se(e["padding-right"])+se(e.width)},getHeight:function(t){var e=getComputedStyle(t);return se(e["border-top-width"])+se(e["border-bottom-width"])+se(e["padding-top"])+se(e["padding-bottom"])+se(e.height)},getOffset:function(t){var e=t,i={left:0,top:0};if(e.offsetParent)do{i.left+=e.offsetLeft,i.top+=e.offsetTop,e=e.offsetParent}while(e);return i},isActive:function(t){return t===document.activeElement&&(t.type||t.href)}},ae=function(t){function e(t,i){Wt(this,e);var r=Qt(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,i)),n=r;return r.__prev=r.getValue(),r.__checkbox=document.createElement("input"),r.__checkbox.setAttribute("type","checkbox"),oe.bind(r.__checkbox,"change",(function(){n.setValue(!n.__prev)}),!1),r.domElement.appendChild(r.__checkbox),r.updateDisplay(),r}return Jt(e,ie),Kt(e,[{key:"setValue",value:function(t){var i=Zt(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"setValue",this).call(this,t);return this.__onFinishChange&&this.__onFinishChange.call(this,this.getValue()),this.__prev=this.getValue(),i}},{key:"updateDisplay",value:function(){return!0===this.getValue()?(this.__checkbox.setAttribute("checked","checked"),this.__checkbox.checked=!0,this.__prev=!0):(this.__checkbox.checked=!1,this.__prev=!1),Zt(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"updateDisplay",this).call(this)}}]),e}(),he=function(t){function e(t,i,r){Wt(this,e);var n=Qt(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,i)),s=r,o=n;if(n.__select=document.createElement("select"),Vt.isArray(s)){var a={};Vt.each(s,(function(t){a[t]=t})),s=a}return Vt.each(s,(function(t,e){var i=document.createElement("option");i.innerHTML=e,i.setAttribute("value",t),o.__select.appendChild(i)})),n.updateDisplay(),oe.bind(n.__select,"change",(function(){var t=this.options[this.selectedIndex].value;o.setValue(t)})),n.domElement.appendChild(n.__select),n}return Jt(e,ie),Kt(e,[{key:"setValue",value:function(t){var i=Zt(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"setValue",this).call(this,t);return this.__onFinishChange&&this.__onFinishChange.call(this,this.getValue()),i}},{key:"updateDisplay",value:function(){return oe.isActive(this.__select)?this:(this.__select.value=this.getValue(),Zt(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"updateDisplay",this).call(this))}}]),e}(),le=function(t){function e(t,i){Wt(this,e);var r=Qt(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,i)),n=r;function s(){n.setValue(n.__input.value)}return r.__input=document.createElement("input"),r.__input.setAttribute("type","text"),oe.bind(r.__input,"keyup",s),oe.bind(r.__input,"change",s),oe.bind(r.__input,"blur",(function(){n.__onFinishChange&&n.__onFinishChange.call(n,n.getValue())})),oe.bind(r.__input,"keydown",(function(t){13===t.keyCode&&this.blur()})),r.updateDisplay(),r.domElement.appendChild(r.__input),r}return Jt(e,ie),Kt(e,[{key:"updateDisplay",value:function(){return oe.isActive(this.__input)||(this.__input.value=this.getValue()),Zt(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"updateDisplay",this).call(this)}}]),e}();function de(t){var e=t.toString();return e.indexOf(".")>-1?e.length-e.indexOf(".")-1:0}var ce=function(t){function e(t,i,r){Wt(this,e);var n=Qt(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,i)),s=r||{};return n.__min=s.min,n.__max=s.max,n.__step=s.step,Vt.isUndefined(n.__step)?0===n.initialValue?n.__impliedStep=1:n.__impliedStep=Math.pow(10,Math.floor(Math.log(Math.abs(n.initialValue))/Math.LN10))/10:n.__impliedStep=n.__step,n.__precision=de(n.__impliedStep),n}return Jt(e,ie),Kt(e,[{key:"setValue",value:function(t){var i=t;return void 0!==this.__min&&i<this.__min?i=this.__min:void 0!==this.__max&&i>this.__max&&(i=this.__max),void 0!==this.__step&&i%this.__step!=0&&(i=Math.round(i/this.__step)*this.__step),Zt(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"setValue",this).call(this,i)}},{key:"min",value:function(t){return this.__min=t,this}},{key:"max",value:function(t){return this.__max=t,this}},{key:"step",value:function(t){return this.__step=t,this.__impliedStep=t,this.__precision=de(t),this}}]),e}();var ue=function(t){function e(t,i,r){Wt(this,e);var n=Qt(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,i,r));n.__truncationSuspended=!1;var s=n,o=void 0;function a(){s.__onFinishChange&&s.__onFinishChange.call(s,s.getValue())}function h(t){var e=o-t.clientY;s.setValue(s.getValue()+e*s.__impliedStep),o=t.clientY}function l(){oe.unbind(window,"mousemove",h),oe.unbind(window,"mouseup",l),a()}return n.__input=document.createElement("input"),n.__input.setAttribute("type","text"),oe.bind(n.__input,"change",(function(){var t=parseFloat(s.__input.value);Vt.isNaN(t)||s.setValue(t)})),oe.bind(n.__input,"blur",(function(){a()})),oe.bind(n.__input,"mousedown",(function(t){oe.bind(window,"mousemove",h),oe.bind(window,"mouseup",l),o=t.clientY})),oe.bind(n.__input,"keydown",(function(t){13===t.keyCode&&(s.__truncationSuspended=!0,this.blur(),s.__truncationSuspended=!1,a())})),n.updateDisplay(),n.domElement.appendChild(n.__input),n}return Jt(e,ce),Kt(e,[{key:"updateDisplay",value:function(){var t,i,r;return this.__input.value=this.__truncationSuspended?this.getValue():(t=this.getValue(),i=this.__precision,r=Math.pow(10,i),Math.round(t*r)/r),Zt(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"updateDisplay",this).call(this)}}]),e}();function fe(t,e,i,r,n){return r+(t-e)/(i-e)*(n-r)}var me=function(t){function e(t,i,r,n,s){Wt(this,e);var o=Qt(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,i,{min:r,max:n,step:s})),a=o;function h(t){t.preventDefault();var e=a.__background.getBoundingClientRect();return a.setValue(fe(t.clientX,e.left,e.right,a.__min,a.__max)),!1}function l(){oe.unbind(window,"mousemove",h),oe.unbind(window,"mouseup",l),a.__onFinishChange&&a.__onFinishChange.call(a,a.getValue())}function d(t){var e=t.touches[0].clientX,i=a.__background.getBoundingClientRect();a.setValue(fe(e,i.left,i.right,a.__min,a.__max))}function c(){oe.unbind(window,"touchmove",d),oe.unbind(window,"touchend",c),a.__onFinishChange&&a.__onFinishChange.call(a,a.getValue())}return o.__background=document.createElement("div"),o.__foreground=document.createElement("div"),oe.bind(o.__background,"mousedown",(function(t){document.activeElement.blur(),oe.bind(window,"mousemove",h),oe.bind(window,"mouseup",l),h(t)})),oe.bind(o.__background,"touchstart",(function(t){if(1!==t.touches.length)return;oe.bind(window,"touchmove",d),oe.bind(window,"touchend",c),d(t)})),oe.addClass(o.__background,"slider"),oe.addClass(o.__foreground,"slider-fg"),o.updateDisplay(),o.__background.appendChild(o.__foreground),o.domElement.appendChild(o.__background),o}return Jt(e,ce),Kt(e,[{key:"updateDisplay",value:function(){var t=(this.getValue()-this.__min)/(this.__max-this.__min);return this.__foreground.style.width=100*t+"%",Zt(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"updateDisplay",this).call(this)}}]),e}(),ge=function(t){function e(t,i,r){Wt(this,e);var n=Qt(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,i)),s=n;return n.__button=document.createElement("div"),n.__button.innerHTML=void 0===r?"Fire":r,oe.bind(n.__button,"click",(function(t){return t.preventDefault(),s.fire(),!1})),oe.addClass(n.__button,"button"),n.domElement.appendChild(n.__button),n}return Jt(e,ie),Kt(e,[{key:"fire",value:function(){this.__onChange&&this.__onChange.call(this),this.getValue().call(this.object),this.__onFinishChange&&this.__onFinishChange.call(this,this.getValue())}}]),e}(),_e=function(t){function e(t,i){Wt(this,e);var r=Qt(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,i));r.__color=new qt(r.getValue()),r.__temp=new qt(0);var n=r;r.domElement=document.createElement("div"),oe.makeSelectable(r.domElement,!1),r.__selector=document.createElement("div"),r.__selector.className="selector",r.__saturation_field=document.createElement("div"),r.__saturation_field.className="saturation-field",r.__field_knob=document.createElement("div"),r.__field_knob.className="field-knob",r.__field_knob_border="2px solid ",r.__hue_knob=document.createElement("div"),r.__hue_knob.className="hue-knob",r.__hue_field=document.createElement("div"),r.__hue_field.className="hue-field",r.__input=document.createElement("input"),r.__input.type="text",r.__input_textShadow="0 1px 1px ",oe.bind(r.__input,"keydown",(function(t){13===t.keyCode&&c.call(this)})),oe.bind(r.__input,"blur",c),oe.bind(r.__selector,"mousedown",(function(){oe.addClass(this,"drag").bind(window,"mouseup",(function(){oe.removeClass(n.__selector,"drag")}))})),oe.bind(r.__selector,"touchstart",(function(){oe.addClass(this,"drag").bind(window,"touchend",(function(){oe.removeClass(n.__selector,"drag")}))}));var s,o=document.createElement("div");function a(t){f(t),oe.bind(window,"mousemove",f),oe.bind(window,"touchmove",f),oe.bind(window,"mouseup",l),oe.bind(window,"touchend",l)}function h(t){m(t),oe.bind(window,"mousemove",m),oe.bind(window,"touchmove",m),oe.bind(window,"mouseup",d),oe.bind(window,"touchend",d)}function l(){oe.unbind(window,"mousemove",f),oe.unbind(window,"touchmove",f),oe.unbind(window,"mouseup",l),oe.unbind(window,"touchend",l),u()}function d(){oe.unbind(window,"mousemove",m),oe.unbind(window,"touchmove",m),oe.unbind(window,"mouseup",d),oe.unbind(window,"touchend",d),u()}function c(){var t=jt(this.value);!1!==t?(n.__color.__state=t,n.setValue(n.__color.toOriginal())):this.value=n.__color.toString()}function u(){n.__onFinishChange&&n.__onFinishChange.call(n,n.__color.toOriginal())}function f(t){-1===t.type.indexOf("touch")&&t.preventDefault();var e=n.__saturation_field.getBoundingClientRect(),i=t.touches&&t.touches[0]||t,r=i.clientX,s=i.clientY,o=(r-e.left)/(e.right-e.left),a=1-(s-e.top)/(e.bottom-e.top);return a>1?a=1:a<0&&(a=0),o>1?o=1:o<0&&(o=0),n.__color.v=a,n.__color.s=o,n.setValue(n.__color.toOriginal()),!1}function m(t){-1===t.type.indexOf("touch")&&t.preventDefault();var e=n.__hue_field.getBoundingClientRect(),i=1-((t.touches&&t.touches[0]||t).clientY-e.top)/(e.bottom-e.top);return i>1?i=1:i<0&&(i=0),n.__color.h=360*i,n.setValue(n.__color.toOriginal()),!1}return Vt.extend(r.__selector.style,{width:"122px",height:"102px",padding:"3px",backgroundColor:"#222",boxShadow:"0px 1px 3px rgba(0,0,0,0.3)"}),Vt.extend(r.__field_knob.style,{position:"absolute",width:"12px",height:"12px",border:r.__field_knob_border+(r.__color.v<.5?"#fff":"#000"),boxShadow:"0px 1px 3px rgba(0,0,0,0.5)",borderRadius:"12px",zIndex:1}),Vt.extend(r.__hue_knob.style,{position:"absolute",width:"15px",height:"2px",borderRight:"4px solid #fff",zIndex:1}),Vt.extend(r.__saturation_field.style,{width:"100px",height:"100px",border:"1px solid #555",marginRight:"3px",display:"inline-block",cursor:"pointer"}),Vt.extend(o.style,{width:"100%",height:"100%",background:"none"}),xe(o,"top","rgba(0,0,0,0)","#000"),Vt.extend(r.__hue_field.style,{width:"15px",height:"100px",border:"1px solid #555",cursor:"ns-resize",position:"absolute",top:"3px",right:"3px"}),(s=r.__hue_field).style.background="",s.style.cssText+="background: -moz-linear-gradient(top,  #ff0000 0%, #ff00ff 17%, #0000ff 34%, #00ffff 50%, #00ff00 67%, #ffff00 84%, #ff0000 100%);",s.style.cssText+="background: -webkit-linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);",s.style.cssText+="background: -o-linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);",s.style.cssText+="background: -ms-linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);",s.style.cssText+="background: linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);",Vt.extend(r.__input.style,{outline:"none",textAlign:"center",color:"#fff",border:0,fontWeight:"bold",textShadow:r.__input_textShadow+"rgba(0,0,0,0.7)"}),oe.bind(r.__saturation_field,"mousedown",a),oe.bind(r.__saturation_field,"touchstart",a),oe.bind(r.__field_knob,"mousedown",a),oe.bind(r.__field_knob,"touchstart",a),oe.bind(r.__hue_field,"mousedown",h),oe.bind(r.__hue_field,"touchstart",h),r.__saturation_field.appendChild(o),r.__selector.appendChild(r.__field_knob),r.__selector.appendChild(r.__saturation_field),r.__selector.appendChild(r.__hue_field),r.__hue_field.appendChild(r.__hue_knob),r.domElement.appendChild(r.__input),r.domElement.appendChild(r.__selector),r.updateDisplay(),r}return Jt(e,ie),Kt(e,[{key:"updateDisplay",value:function(){var t=jt(this.getValue());if(!1!==t){var e=!1;Vt.each(qt.COMPONENTS,(function(i){if(!Vt.isUndefined(t[i])&&!Vt.isUndefined(this.__color.__state[i])&&t[i]!==this.__color.__state[i])return e=!0,{}}),this),e&&Vt.extend(this.__color.__state,t)}Vt.extend(this.__temp.__state,this.__color.__state),this.__temp.a=1;var i=this.__color.v<.5||this.__color.s>.5?255:0,r=255-i;Vt.extend(this.__field_knob.style,{marginLeft:100*this.__color.s-7+"px",marginTop:100*(1-this.__color.v)-7+"px",backgroundColor:this.__temp.toHexString(),border:this.__field_knob_border+"rgb("+i+","+i+","+i+")"}),this.__hue_knob.style.marginTop=100*(1-this.__color.h/360)+"px",this.__temp.s=1,this.__temp.v=1,xe(this.__saturation_field,"left","#fff",this.__temp.toHexString()),this.__input.value=this.__color.toString(),Vt.extend(this.__input.style,{backgroundColor:this.__color.toHexString(),color:"rgb("+i+","+i+","+i+")",textShadow:this.__input_textShadow+"rgba("+r+","+r+","+r+",.7)"})}}]),e}(),pe=["-moz-","-o-","-webkit-","-ms-",""];function xe(t,e,i,r){t.style.background="",Vt.each(pe,(function(n){t.style.cssText+="background: "+n+"linear-gradient("+e+", "+i+" 0%, "+r+" 100%); "}))}var ve=function(t,e){var i=e||document,r=document.createElement("style");r.type="text/css",r.innerHTML=t;var n=i.getElementsByTagName("head")[0];try{n.appendChild(r)}catch(t){}},be='<div id="dg-save" class="dg dialogue">\n\n  Here\'s the new load parameter for your <code>GUI</code>\'s constructor:\n\n  <textarea id="dg-new-constructor"></textarea>\n\n  <div id="dg-save-locally">\n\n    <input id="dg-local-storage" type="checkbox"/> Automatically save\n    values to <code>localStorage</code> on exit.\n\n    <div id="dg-local-explain">The values saved to <code>localStorage</code> will\n      override those passed to <code>dat.GUI</code>\'s constructor. This makes it\n      easier to work incrementally, but <code>localStorage</code> is fragile,\n      and your friends may not see the same values you do.\n\n    </div>\n\n  </div>\n\n</div>',Ee=function(t,e){var i=t[e];return Vt.isArray(arguments[2])||Vt.isObject(arguments[2])?new he(t,e,arguments[2]):Vt.isNumber(i)?Vt.isNumber(arguments[2])&&Vt.isNumber(arguments[3])?Vt.isNumber(arguments[4])?new me(t,e,arguments[2],arguments[3],arguments[4]):new me(t,e,arguments[2],arguments[3]):Vt.isNumber(arguments[4])?new ue(t,e,{min:arguments[2],max:arguments[3],step:arguments[4]}):new ue(t,e,{min:arguments[2],max:arguments[3]}):Vt.isString(i)?new le(t,e):Vt.isFunction(i)?new ge(t,e,""):Vt.isBoolean(i)?new ae(t,e):null};var Ae=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t){setTimeout(t,1e3/60)},Te=function(){function t(){Wt(this,t),this.backgroundElement=document.createElement("div"),Vt.extend(this.backgroundElement.style,{backgroundColor:"rgba(0,0,0,0.8)",top:0,left:0,display:"none",zIndex:"1000",opacity:0,WebkitTransition:"opacity 0.2s linear",transition:"opacity 0.2s linear"}),oe.makeFullscreen(this.backgroundElement),this.backgroundElement.style.position="fixed",this.domElement=document.createElement("div"),Vt.extend(this.domElement.style,{position:"fixed",display:"none",zIndex:"1001",opacity:0,WebkitTransition:"-webkit-transform 0.2s ease-out, opacity 0.2s linear",transition:"transform 0.2s ease-out, opacity 0.2s linear"}),document.body.appendChild(this.backgroundElement),document.body.appendChild(this.domElement);var e=this;oe.bind(this.backgroundElement,"click",(function(){e.hide()}))}return Kt(t,[{key:"show",value:function(){var t=this;this.backgroundElement.style.display="block",this.domElement.style.display="block",this.domElement.style.opacity=0,this.domElement.style.webkitTransform="scale(1.1)",this.layout(),Vt.defer((function(){t.backgroundElement.style.opacity=1,t.domElement.style.opacity=1,t.domElement.style.webkitTransform="scale(1)"}))}},{key:"hide",value:function(){var t=this,e=function e(){t.domElement.style.display="none",t.backgroundElement.style.display="none",oe.unbind(t.domElement,"webkitTransitionEnd",e),oe.unbind(t.domElement,"transitionend",e),oe.unbind(t.domElement,"oTransitionEnd",e)};oe.bind(this.domElement,"webkitTransitionEnd",e),oe.bind(this.domElement,"transitionend",e),oe.bind(this.domElement,"oTransitionEnd",e),this.backgroundElement.style.opacity=0,this.domElement.style.opacity=0,this.domElement.style.webkitTransform="scale(1.1)"}},{key:"layout",value:function(){this.domElement.style.left=window.innerWidth/2-oe.getWidth(this.domElement)/2+"px",this.domElement.style.top=window.innerHeight/2-oe.getHeight(this.domElement)/2+"px"}}]),t}(),Re=function(t){if(t&&"undefined"!=typeof window){var e=document.createElement("style");return e.setAttribute("type","text/css"),e.innerHTML=t,document.head.appendChild(e),t}}(".dg ul{list-style:none;margin:0;padding:0;width:100%;clear:both}.dg.ac{position:fixed;top:0;left:0;right:0;height:0;z-index:0}.dg:not(.ac) .main{overflow:hidden}.dg.main{-webkit-transition:opacity .1s linear;-o-transition:opacity .1s linear;-moz-transition:opacity .1s linear;transition:opacity .1s linear}.dg.main.taller-than-window{overflow-y:auto}.dg.main.taller-than-window .close-button{opacity:1;margin-top:-1px;border-top:1px solid #2c2c2c}.dg.main ul.closed .close-button{opacity:1 !important}.dg.main:hover .close-button,.dg.main .close-button.drag{opacity:1}.dg.main .close-button{-webkit-transition:opacity .1s linear;-o-transition:opacity .1s linear;-moz-transition:opacity .1s linear;transition:opacity .1s linear;border:0;line-height:19px;height:20px;cursor:pointer;text-align:center;background-color:#000}.dg.main .close-button.close-top{position:relative}.dg.main .close-button.close-bottom{position:absolute}.dg.main .close-button:hover{background-color:#111}.dg.a{float:right;margin-right:15px;overflow-y:visible}.dg.a.has-save>ul.close-top{margin-top:0}.dg.a.has-save>ul.close-bottom{margin-top:27px}.dg.a.has-save>ul.closed{margin-top:0}.dg.a .save-row{top:0;z-index:1002}.dg.a .save-row.close-top{position:relative}.dg.a .save-row.close-bottom{position:fixed}.dg li{-webkit-transition:height .1s ease-out;-o-transition:height .1s ease-out;-moz-transition:height .1s ease-out;transition:height .1s ease-out;-webkit-transition:overflow .1s linear;-o-transition:overflow .1s linear;-moz-transition:overflow .1s linear;transition:overflow .1s linear}.dg li:not(.folder){cursor:auto;height:27px;line-height:27px;padding:0 4px 0 5px}.dg li.folder{padding:0;border-left:4px solid rgba(0,0,0,0)}.dg li.title{cursor:pointer;margin-left:-4px}.dg .closed li:not(.title),.dg .closed ul li,.dg .closed ul li>*{height:0;overflow:hidden;border:0}.dg .cr{clear:both;padding-left:3px;height:27px;overflow:hidden}.dg .property-name{cursor:default;float:left;clear:left;width:40%;overflow:hidden;text-overflow:ellipsis}.dg .cr.function .property-name{width:100%}.dg .c{float:left;width:60%;position:relative}.dg .c input[type=text]{border:0;margin-top:4px;padding:3px;width:100%;float:right}.dg .has-slider input[type=text]{width:30%;margin-left:0}.dg .slider{float:left;width:66%;margin-left:-5px;margin-right:0;height:19px;margin-top:4px}.dg .slider-fg{height:100%}.dg .c input[type=checkbox]{margin-top:7px}.dg .c select{margin-top:5px}.dg .cr.function,.dg .cr.function .property-name,.dg .cr.function *,.dg .cr.boolean,.dg .cr.boolean *{cursor:pointer}.dg .cr.color{overflow:visible}.dg .selector{display:none;position:absolute;margin-left:-9px;margin-top:23px;z-index:10}.dg .c:hover .selector,.dg .selector.drag{display:block}.dg li.save-row{padding:0}.dg li.save-row .button{display:inline-block;padding:0px 6px}.dg.dialogue{background-color:#222;width:460px;padding:15px;font-size:13px;line-height:15px}#dg-new-constructor{padding:10px;color:#222;font-family:Monaco, monospace;font-size:10px;border:0;resize:none;box-shadow:inset 1px 1px 1px #888;word-wrap:break-word;margin:12px 0;display:block;width:440px;overflow-y:scroll;height:100px;position:relative}#dg-local-explain{display:none;font-size:11px;line-height:17px;border-radius:3px;background-color:#333;padding:8px;margin-top:10px}#dg-local-explain code{font-size:10px}#dat-gui-save-locally{display:none}.dg{color:#eee;font:11px 'Lucida Grande', sans-serif;text-shadow:0 -1px 0 #111}.dg.main::-webkit-scrollbar{width:5px;background:#1a1a1a}.dg.main::-webkit-scrollbar-corner{height:0;display:none}.dg.main::-webkit-scrollbar-thumb{border-radius:5px;background:#676767}.dg li:not(.folder){background:#1a1a1a;border-bottom:1px solid #2c2c2c}.dg li.save-row{line-height:25px;background:#dad5cb;border:0}.dg li.save-row select{margin-left:5px;width:108px}.dg li.save-row .button{margin-left:5px;margin-top:1px;border-radius:2px;font-size:9px;line-height:7px;padding:4px 4px 5px 4px;background:#c5bdad;color:#fff;text-shadow:0 1px 0 #b0a58f;box-shadow:0 -1px 0 #b0a58f;cursor:pointer}.dg li.save-row .button.gears{background:#c5bdad url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAsAAAANCAYAAAB/9ZQ7AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAQJJREFUeNpiYKAU/P//PwGIC/ApCABiBSAW+I8AClAcgKxQ4T9hoMAEUrxx2QSGN6+egDX+/vWT4e7N82AMYoPAx/evwWoYoSYbACX2s7KxCxzcsezDh3evFoDEBYTEEqycggWAzA9AuUSQQgeYPa9fPv6/YWm/Acx5IPb7ty/fw+QZblw67vDs8R0YHyQhgObx+yAJkBqmG5dPPDh1aPOGR/eugW0G4vlIoTIfyFcA+QekhhHJhPdQxbiAIguMBTQZrPD7108M6roWYDFQiIAAv6Aow/1bFwXgis+f2LUAynwoIaNcz8XNx3Dl7MEJUDGQpx9gtQ8YCueB+D26OECAAQDadt7e46D42QAAAABJRU5ErkJggg==) 2px 1px no-repeat;height:7px;width:8px}.dg li.save-row .button:hover{background-color:#bab19e;box-shadow:0 -1px 0 #b0a58f}.dg li.folder{border-bottom:0}.dg li.title{padding-left:16px;background:#000 url(data:image/gif;base64,R0lGODlhBQAFAJEAAP////Pz8////////yH5BAEAAAIALAAAAAAFAAUAAAIIlI+hKgFxoCgAOw==) 6px 10px no-repeat;cursor:pointer;border-bottom:1px solid rgba(255,255,255,0.2)}.dg .closed li.title{background-image:url(data:image/gif;base64,R0lGODlhBQAFAJEAAP////Pz8////////yH5BAEAAAIALAAAAAAFAAUAAAIIlGIWqMCbWAEAOw==)}.dg .cr.boolean{border-left:3px solid #806787}.dg .cr.color{border-left:3px solid}.dg .cr.function{border-left:3px solid #e61d5f}.dg .cr.number{border-left:3px solid #2FA1D6}.dg .cr.number input[type=text]{color:#2FA1D6}.dg .cr.string{border-left:3px solid #1ed36f}.dg .cr.string input[type=text]{color:#1ed36f}.dg .cr.function:hover,.dg .cr.boolean:hover{background:#111}.dg .c input[type=text]{background:#303030;outline:none}.dg .c input[type=text]:hover{background:#3c3c3c}.dg .c input[type=text]:focus{background:#494949;color:#fff}.dg .c .slider{background:#303030;cursor:ew-resize}.dg .c .slider-fg{background:#2FA1D6;max-width:100%}.dg .c .slider:hover{background:#3c3c3c}.dg .c .slider:hover .slider-fg{background:#44abda}\n");ve(Re);var Ce=function(){try{return!!window.localStorage}catch(t){return!1}}(),we=void 0,Me=!0,ye=void 0,Fe=!1,Se=[],Oe=function t(e){var i=this,r=e||{};this.domElement=document.createElement("div"),this.__ul=document.createElement("ul"),this.domElement.appendChild(this.__ul),oe.addClass(this.domElement,"dg"),this.__folders={},this.__controllers=[],this.__rememberedObjects=[],this.__rememberedObjectIndecesToControllers=[],this.__listening=[],r=Vt.defaults(r,{closeOnTop:!1,autoPlace:!0,width:t.DEFAULT_WIDTH}),r=Vt.defaults(r,{resizable:r.autoPlace,hideable:r.autoPlace}),Vt.isUndefined(r.load)?r.load={preset:"Default"}:r.preset&&(r.load.preset=r.preset),Vt.isUndefined(r.parent)&&r.hideable&&Se.push(this),r.resizable=Vt.isUndefined(r.parent)&&r.resizable,r.autoPlace&&Vt.isUndefined(r.scrollable)&&(r.scrollable=!0);var n,s=Ce&&"true"===localStorage.getItem(Ue(this,"isLocal")),o=void 0,a=void 0;if(Object.defineProperties(this,{parent:{get:function(){return r.parent}},scrollable:{get:function(){return r.scrollable}},autoPlace:{get:function(){return r.autoPlace}},closeOnTop:{get:function(){return r.closeOnTop}},preset:{get:function(){return i.parent?i.getRoot().preset:r.load.preset},set:function(t){i.parent?i.getRoot().preset=t:r.load.preset=t,function(t){for(var e=0;e<t.__preset_select.length;e++)t.__preset_select[e].value===t.preset&&(t.__preset_select.selectedIndex=e)}(this),i.revert()}},width:{get:function(){return r.width},set:function(t){r.width=t,He(i,t)}},name:{get:function(){return r.name},set:function(t){r.name=t,a&&(a.innerHTML=r.name)}},closed:{get:function(){return r.closed},set:function(e){r.closed=e,r.closed?oe.addClass(i.__ul,t.CLASS_CLOSED):oe.removeClass(i.__ul,t.CLASS_CLOSED),this.onResize(),i.__closeButton&&(i.__closeButton.innerHTML=e?t.TEXT_OPEN:t.TEXT_CLOSED)}},load:{get:function(){return r.load}},useLocalStorage:{get:function(){return s},set:function(t){Ce&&(s=t,t?oe.bind(window,"unload",o):oe.unbind(window,"unload",o),localStorage.setItem(Ue(i,"isLocal"),t))}}}),Vt.isUndefined(r.parent)){if(this.closed=r.closed||!1,oe.addClass(this.domElement,t.CLASS_MAIN),oe.makeSelectable(this.domElement,!1),Ce&&s){i.useLocalStorage=!0;var h=localStorage.getItem(Ue(this,"gui"));h&&(r.load=JSON.parse(h))}this.__closeButton=document.createElement("div"),this.__closeButton.innerHTML=t.TEXT_CLOSED,oe.addClass(this.__closeButton,t.CLASS_CLOSE_BUTTON),r.closeOnTop?(oe.addClass(this.__closeButton,t.CLASS_CLOSE_TOP),this.domElement.insertBefore(this.__closeButton,this.domElement.childNodes[0])):(oe.addClass(this.__closeButton,t.CLASS_CLOSE_BOTTOM),this.domElement.appendChild(this.__closeButton)),oe.bind(this.__closeButton,"click",(function(){i.closed=!i.closed}))}else{void 0===r.closed&&(r.closed=!0);var l=document.createTextNode(r.name);oe.addClass(l,"controller-name"),a=Pe(i,l);oe.addClass(this.__ul,t.CLASS_CLOSED),oe.addClass(a,"title"),oe.bind(a,"click",(function(t){return t.preventDefault(),i.closed=!i.closed,!1})),r.closed||(this.closed=!1)}r.autoPlace&&(Vt.isUndefined(r.parent)&&(Me&&(ye=document.createElement("div"),oe.addClass(ye,"dg"),oe.addClass(ye,t.CLASS_AUTO_PLACE_CONTAINER),document.body.appendChild(ye),Me=!1),ye.appendChild(this.domElement),oe.addClass(this.domElement,t.CLASS_AUTO_PLACE)),this.parent||He(i,r.width)),this.__resizeHandler=function(){i.onResizeDebounced()},oe.bind(window,"resize",this.__resizeHandler),oe.bind(this.__ul,"webkitTransitionEnd",this.__resizeHandler),oe.bind(this.__ul,"transitionend",this.__resizeHandler),oe.bind(this.__ul,"oTransitionEnd",this.__resizeHandler),this.onResize(),r.resizable&&Be(this),o=function(){Ce&&"true"===localStorage.getItem(Ue(i,"isLocal"))&&localStorage.setItem(Ue(i,"gui"),JSON.stringify(i.getSaveObject()))},this.saveToLocalStorageIfPossible=o,r.parent||((n=i.getRoot()).width+=1,Vt.defer((function(){n.width-=1})))};function Pe(t,e,i){var r=document.createElement("li");return e&&r.appendChild(e),i?t.__ul.insertBefore(r,i):t.__ul.appendChild(r),t.onResize(),r}function Ie(t){oe.unbind(window,"resize",t.__resizeHandler),t.saveToLocalStorageIfPossible&&oe.unbind(window,"unload",t.saveToLocalStorageIfPossible)}function De(t,e){var i=t.__preset_select[t.__preset_select.selectedIndex];i.innerHTML=e?i.value+"*":i.value}function ke(t,e){var i=t.getRoot(),r=i.__rememberedObjects.indexOf(e.object);if(-1!==r){var n=i.__rememberedObjectIndecesToControllers[r];if(void 0===n&&(n={},i.__rememberedObjectIndecesToControllers[r]=n),n[e.property]=e,i.load&&i.load.remembered){var s=i.load.remembered,o=void 0;if(s[t.preset])o=s[t.preset];else{if(!s.Default)return;o=s.Default}if(o[r]&&void 0!==o[r][e.property]){var a=o[r][e.property];e.initialValue=a,e.setValue(a)}}}}function Ne(t,e,i,r){if(void 0===e[i])throw new Error('Object "'+e+'" has no property "'+i+'"');var n=void 0;if(r.color)n=new _e(e,i);else{var s=[e,i].concat(r.factoryArgs);n=Ee.apply(t,s)}r.before instanceof ie&&(r.before=r.before.__li),ke(t,n),oe.addClass(n.domElement,"c");var o=document.createElement("span");oe.addClass(o,"property-name"),o.innerHTML=n.property;var a=document.createElement("div");a.appendChild(o),a.appendChild(n.domElement);var h=Pe(t,a,r.before);return oe.addClass(h,Oe.CLASS_CONTROLLER_ROW),n instanceof _e?oe.addClass(h,"color"):oe.addClass(h,Yt(n.getValue())),function(t,e,i){if(i.__li=e,i.__gui=t,Vt.extend(i,{options:function(e){if(arguments.length>1){var r=i.__li.nextElementSibling;return i.remove(),Ne(t,i.object,i.property,{before:r,factoryArgs:[Vt.toArray(arguments)]})}if(Vt.isArray(e)||Vt.isObject(e)){var n=i.__li.nextElementSibling;return i.remove(),Ne(t,i.object,i.property,{before:n,factoryArgs:[e]})}},name:function(t){return i.__li.firstElementChild.firstElementChild.innerHTML=t,i},listen:function(){return i.__gui.listen(i),i},remove:function(){return i.__gui.remove(i),i}}),i instanceof me){var r=new ue(i.object,i.property,{min:i.__min,max:i.__max,step:i.__step});Vt.each(["updateDisplay","onChange","onFinishChange","step","min","max"],(function(t){var e=i[t],n=r[t];i[t]=r[t]=function(){var t=Array.prototype.slice.call(arguments);return n.apply(r,t),e.apply(i,t)}})),oe.addClass(e,"has-slider"),i.domElement.insertBefore(r.domElement,i.domElement.firstElementChild)}else if(i instanceof ue){var n=function(e){if(Vt.isNumber(i.__min)&&Vt.isNumber(i.__max)){var r=i.__li.firstElementChild.firstElementChild.innerHTML,n=i.__gui.__listening.indexOf(i)>-1;i.remove();var s=Ne(t,i.object,i.property,{before:i.__li.nextElementSibling,factoryArgs:[i.__min,i.__max,i.__step]});return s.name(r),n&&s.listen(),s}return e};i.min=Vt.compose(n,i.min),i.max=Vt.compose(n,i.max)}else i instanceof ae?(oe.bind(e,"click",(function(){oe.fakeEvent(i.__checkbox,"click")})),oe.bind(i.__checkbox,"click",(function(t){t.stopPropagation()}))):i instanceof ge?(oe.bind(e,"click",(function(){oe.fakeEvent(i.__button,"click")})),oe.bind(e,"mouseover",(function(){oe.addClass(i.__button,"hover")})),oe.bind(e,"mouseout",(function(){oe.removeClass(i.__button,"hover")}))):i instanceof _e&&(oe.addClass(e,"color"),i.updateDisplay=Vt.compose((function(t){return e.style.borderLeftColor=i.__color.toString(),t}),i.updateDisplay),i.updateDisplay());i.setValue=Vt.compose((function(e){return t.getRoot().__preset_select&&i.isModified()&&De(t.getRoot(),!0),e}),i.setValue)}(t,h,n),t.__controllers.push(n),n}function Ue(t,e){return document.location.href+"."+e}function Le(t,e,i){var r=document.createElement("option");r.innerHTML=e,r.value=e,t.__preset_select.appendChild(r),i&&(t.__preset_select.selectedIndex=t.__preset_select.length-1)}function Ge(t,e){e.style.display=t.useLocalStorage?"block":"none"}function Ve(t){var e=t.__save_row=document.createElement("li");oe.addClass(t.domElement,"has-save"),t.__ul.insertBefore(e,t.__ul.firstChild),oe.addClass(e,"save-row");var i=document.createElement("span");i.innerHTML="&nbsp;",oe.addClass(i,"button gears");var r=document.createElement("span");r.innerHTML="Save",oe.addClass(r,"button"),oe.addClass(r,"save");var n=document.createElement("span");n.innerHTML="New",oe.addClass(n,"button"),oe.addClass(n,"save-as");var s=document.createElement("span");s.innerHTML="Revert",oe.addClass(s,"button"),oe.addClass(s,"revert");var o=t.__preset_select=document.createElement("select");if(t.load&&t.load.remembered?Vt.each(t.load.remembered,(function(e,i){Le(t,i,i===t.preset)})):Le(t,"Default",!1),oe.bind(o,"change",(function(){for(var e=0;e<t.__preset_select.length;e++)t.__preset_select[e].innerHTML=t.__preset_select[e].value;t.preset=this.value})),e.appendChild(o),e.appendChild(i),e.appendChild(r),e.appendChild(n),e.appendChild(s),Ce){var a=document.getElementById("dg-local-explain"),h=document.getElementById("dg-local-storage");document.getElementById("dg-save-locally").style.display="block","true"===localStorage.getItem(Ue(0,"isLocal"))&&h.setAttribute("checked","checked"),Ge(t,a),oe.bind(h,"change",(function(){t.useLocalStorage=!t.useLocalStorage,Ge(t,a)}))}var l=document.getElementById("dg-new-constructor");oe.bind(l,"keydown",(function(t){!t.metaKey||67!==t.which&&67!==t.keyCode||we.hide()})),oe.bind(i,"click",(function(){l.innerHTML=JSON.stringify(t.getSaveObject(),void 0,2),we.show(),l.focus(),l.select()})),oe.bind(r,"click",(function(){t.save()})),oe.bind(n,"click",(function(){var e=prompt("Enter a new preset name.");e&&t.saveAs(e)})),oe.bind(s,"click",(function(){t.revert()}))}function Be(t){var e=void 0;function i(i){return i.preventDefault(),t.width+=e-i.clientX,t.onResize(),e=i.clientX,!1}function r(){oe.removeClass(t.__closeButton,Oe.CLASS_DRAG),oe.unbind(window,"mousemove",i),oe.unbind(window,"mouseup",r)}function n(n){return n.preventDefault(),e=n.clientX,oe.addClass(t.__closeButton,Oe.CLASS_DRAG),oe.bind(window,"mousemove",i),oe.bind(window,"mouseup",r),!1}t.__resize_handle=document.createElement("div"),Vt.extend(t.__resize_handle.style,{width:"6px",marginLeft:"-3px",height:"200px",cursor:"ew-resize",position:"absolute"}),oe.bind(t.__resize_handle,"mousedown",n),oe.bind(t.__closeButton,"mousedown",n),t.domElement.insertBefore(t.__resize_handle,t.domElement.firstElementChild)}function He(t,e){t.domElement.style.width=e+"px",t.__save_row&&t.autoPlace&&(t.__save_row.style.width=e+"px"),t.__closeButton&&(t.__closeButton.style.width=e+"px")}function Xe(t,e){var i={};return Vt.each(t.__rememberedObjects,(function(r,n){var s={},o=t.__rememberedObjectIndecesToControllers[n];Vt.each(o,(function(t,i){s[i]=e?t.initialValue:t.getValue()})),i[n]=s})),i}function je(t){0!==t.length&&Ae.call(window,(function(){je(t)})),Vt.each(t,(function(t){t.updateDisplay()}))}Oe.toggleHide=function(){Fe=!Fe,Vt.each(Se,(function(t){t.domElement.style.display=Fe?"none":""}))},Oe.CLASS_AUTO_PLACE="a",Oe.CLASS_AUTO_PLACE_CONTAINER="ac",Oe.CLASS_MAIN="main",Oe.CLASS_CONTROLLER_ROW="cr",Oe.CLASS_TOO_TALL="taller-than-window",Oe.CLASS_CLOSED="closed",Oe.CLASS_CLOSE_BUTTON="close-button",Oe.CLASS_CLOSE_TOP="close-top",Oe.CLASS_CLOSE_BOTTOM="close-bottom",Oe.CLASS_DRAG="drag",Oe.DEFAULT_WIDTH=245,Oe.TEXT_CLOSED="Close Controls",Oe.TEXT_OPEN="Open Controls",Oe._keydownHandler=function(t){"text"===document.activeElement.type||72!==t.which&&72!==t.keyCode||Oe.toggleHide()},oe.bind(window,"keydown",Oe._keydownHandler,!1),Vt.extend(Oe.prototype,{add:function(t,e){return Ne(this,t,e,{factoryArgs:Array.prototype.slice.call(arguments,2)})},addColor:function(t,e){return Ne(this,t,e,{color:!0})},remove:function(t){this.__ul.removeChild(t.__li),this.__controllers.splice(this.__controllers.indexOf(t),1);var e=this;Vt.defer((function(){e.onResize()}))},destroy:function(){if(this.parent)throw new Error("Only the root GUI should be removed with .destroy(). For subfolders, use gui.removeFolder(folder) instead.");this.autoPlace&&ye.removeChild(this.domElement);var t=this;Vt.each(this.__folders,(function(e){t.removeFolder(e)})),oe.unbind(window,"keydown",Oe._keydownHandler,!1),Ie(this)},addFolder:function(t){if(void 0!==this.__folders[t])throw new Error('You already have a folder in this GUI by the name "'+t+'"');var e={name:t,parent:this};e.autoPlace=this.autoPlace,this.load&&this.load.folders&&this.load.folders[t]&&(e.closed=this.load.folders[t].closed,e.load=this.load.folders[t]);var i=new Oe(e);this.__folders[t]=i;var r=Pe(this,i.domElement);return oe.addClass(r,"folder"),i},removeFolder:function(t){this.__ul.removeChild(t.domElement.parentElement),delete this.__folders[t.name],this.load&&this.load.folders&&this.load.folders[t.name]&&delete this.load.folders[t.name],Ie(t);var e=this;Vt.each(t.__folders,(function(e){t.removeFolder(e)})),Vt.defer((function(){e.onResize()}))},open:function(){this.closed=!1},close:function(){this.closed=!0},hide:function(){this.domElement.style.display="none"},show:function(){this.domElement.style.display=""},onResize:function(){var t=this.getRoot();if(t.scrollable){var e=oe.getOffset(t.__ul).top,i=0;Vt.each(t.__ul.childNodes,(function(e){t.autoPlace&&e===t.__save_row||(i+=oe.getHeight(e))})),window.innerHeight-e-20<i?(oe.addClass(t.domElement,Oe.CLASS_TOO_TALL),t.__ul.style.height=window.innerHeight-e-20+"px"):(oe.removeClass(t.domElement,Oe.CLASS_TOO_TALL),t.__ul.style.height="auto")}t.__resize_handle&&Vt.defer((function(){t.__resize_handle.style.height=t.__ul.offsetHeight+"px"})),t.__closeButton&&(t.__closeButton.style.width=t.width+"px")},onResizeDebounced:Vt.debounce((function(){this.onResize()}),50),remember:function(){if(Vt.isUndefined(we)&&((we=new Te).domElement.innerHTML=be),this.parent)throw new Error("You can only call remember on a top level GUI.");var t=this;Vt.each(Array.prototype.slice.call(arguments),(function(e){0===t.__rememberedObjects.length&&Ve(t),-1===t.__rememberedObjects.indexOf(e)&&t.__rememberedObjects.push(e)})),this.autoPlace&&He(this,this.width)},getRoot:function(){for(var t=this;t.parent;)t=t.parent;return t},getSaveObject:function(){var t=this.load;return t.closed=this.closed,this.__rememberedObjects.length>0&&(t.preset=this.preset,t.remembered||(t.remembered={}),t.remembered[this.preset]=Xe(this)),t.folders={},Vt.each(this.__folders,(function(e,i){t.folders[i]=e.getSaveObject()})),t},save:function(){this.load.remembered||(this.load.remembered={}),this.load.remembered[this.preset]=Xe(this),De(this,!1),this.saveToLocalStorageIfPossible()},saveAs:function(t){this.load.remembered||(this.load.remembered={},this.load.remembered.Default=Xe(this,!0)),this.load.remembered[t]=Xe(this),this.preset=t,Le(this,t,!0),this.saveToLocalStorageIfPossible()},revert:function(t){Vt.each(this.__controllers,(function(e){this.getRoot().load.remembered?ke(t||this.getRoot(),e):e.setValue(e.initialValue),e.__onFinishChange&&e.__onFinishChange.call(e,e.getValue())}),this),Vt.each(this.__folders,(function(t){t.revert(t)})),t||De(this.getRoot(),!1)},listen:function(t){var e=0===this.__listening.length;this.__listening.push(t),e&&je(this.__listening)},updateDisplay:function(){Vt.each(this.__controllers,(function(t){t.updateDisplay()})),Vt.each(this.__folders,(function(t){t.updateDisplay()}))}});var ze=Oe;let $e;var Ye;Ye=()=>{$e=new It,$e.ready=()=>{!function(){var t,e;null===(t=document.getElementById("message"))||void 0===t||t.classList.add("hidden"),null===(e=document.getElementById("canvasGL"))||void 0===e||e.classList.remove("transparent"),setTimeout((()=>{var t;return null===(t=document.querySelector(".promo"))||void 0===t?void 0:t.classList.remove("transparent")}),4e3),setTimeout((()=>{var t;return null===(t=document.querySelector("#toggleFullscreen"))||void 0===t?void 0:t.classList.remove("transparent")}),1800);const i=new ze;i.add($e.config,"preset",{Sunrise:0,Day:1,Sunset:2,Night:3}).onChange((t=>$e.changeScene(t))),i.add($e.config,"heightOffset",0,20),i.add($e.config,"treesHeightOffset",4,15),i.add($e.config,"grassAmount",0,5).step(.1),i.add($e.config,"fogStartDistance",0,150),i.add($e.config,"fogDistance",0,200),i.add($e.config,"fogHeightOffset",-5,5),i.add($e.config,"fogHeightMultiplier",0,1).step(.01)}()},$e.init("canvasGL",!0);const e=document.getElementById("canvasGL");new Nt($e,{canvas:e,movementSpeed:35,rotationSpeed:.006});const i=new t;document.getElementById("toggleFullscreen").addEventListener("click",(()=>{document.body.classList.contains("fs")?i.exitFullScreen():i.enterFullScreen(),i.addFullScreenListener((function(){i.isFullScreen()?document.body.classList.add("fs"):document.body.classList.remove("fs")}))}))},"loading"!==document.readyState?Ye():document.addEventListener("DOMContentLoaded",Ye);
//# sourceMappingURL=index.min.js.map
